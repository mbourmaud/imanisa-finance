{
  "project": "Imanisa Finance",
  "mode": "feature",
  "branchName": "ralph/phase-1-immobilier",
  "baseBranch": "main",
  "description": "Phase 0+1+2+3+4+5: Fondations, immobilier, import bancaire, investissements, tests, PWA mobile",
  "skills": [
    {
      "name": "web-interface-guidelines",
      "usage": "OBLIGATOIRE pour toutes les US UI (US-109, US-209, US-300 à US-307). Exécuter '/web-interface-guidelines <fichier>' sur chaque composant Svelte créé ou modifié pour vérifier conformité aux Vercel Web Interface Guidelines."
    },
    {
      "name": "frontend-design",
      "usage": "Utiliser pour créer des interfaces polies et distinctives. Activer automatiquement pour le travail frontend."
    }
  ],
  "instructions": {
    "testing": "Pour les US de tests (US-900+): Si un test échoue, identifier l'US source du bug, corriger le code, relancer les tests en boucle jusqu'à ce que TOUS passent. Ne JAMAIS marquer une US test comme passes:true tant que des tests échouent.",
    "ui": "Pour les US UI (US-109, US-209, US-300+): Toujours exécuter /web-interface-guidelines sur les fichiers .svelte après modification. Mobile-first obligatoire. Touch targets ≥44px. Respecter prefers-reduced-motion.",
    "quality": "Avant de marquer une US comme passes:true, vérifier: 1) Typecheck passe (npx tsc --noEmit), 2) Pas d'erreurs console, 3) Code DRY et KISS, 4) Pas de code mort."
  },
  "userStories": [
    {
      "id": "US-000",
      "title": "Migration SQLite → Turso",
      "description": "Migrer la base de données de SQLite (better-sqlite3) vers Turso (@libsql/client) pour permettre le déploiement sur Vercel",
      "acceptanceCriteria": [
        "Installer @libsql/client et supprimer better-sqlite3",
        "Créer src/infrastructure/database/turso.ts avec client async",
        "Migrer tous les appels db.prepare().all() vers await db.execute()",
        "Configurer variables TURSO_URL et TURSO_AUTH_TOKEN dans .env.example",
        "L'app démarre sans erreur avec Turso (ou mode mock si pas de credentials)"
      ],
      "files": ["src/infrastructure/database/", "package.json", ".env.example"],
      "priority": 1,
      "passes": true,
      "notes": "Créer la DB Turso manuellement: turso db create imanisa-finance"
    },
    {
      "id": "US-001",
      "title": "Intégration Drizzle ORM",
      "description": "Remplacer les requêtes SQL manuelles par Drizzle ORM pour un accès type-safe à la base de données",
      "dependsOn": ["US-000"],
      "acceptanceCriteria": [
        "Installer drizzle-orm et drizzle-kit",
        "Créer src/infrastructure/database/schema/index.ts avec le schéma Drizzle (tables existantes + real estate)",
        "Créer src/infrastructure/database/drizzle.ts exportant db configuré avec LibSQL",
        "Migrer les repositories existants pour utiliser Drizzle au lieu de execute() manuel",
        "Supprimer le code SQL manuel devenu inutile",
        "Configurer drizzle.config.ts pour les migrations",
        "Typecheck passe"
      ],
      "files": ["src/infrastructure/database/schema/", "src/infrastructure/database/drizzle.ts", "drizzle.config.ts", "package.json"],
      "priority": 2,
      "passes": true,
      "notes": "Drizzle est léger, type-safe, et supporte LibSQL nativement. Alternative à Prisma pour SQLite/Turso."
    },
    {
      "id": "US-010",
      "title": "Schéma BDD Immobilier",
      "description": "Créer les tables du module immobilier: entities, entity_shares, properties, property_ownership, loans, loan_responsibility, property_charges",
      "dependsOn": ["US-000"],
      "acceptanceCriteria": [
        "Créer fichier src/infrastructure/database/migrations/001_real_estate.sql avec toutes les tables",
        "Créer les types TypeScript dans src/lib/types/real-estate.ts",
        "Créer src/infrastructure/repositories/RealEstateRepository.ts avec méthodes CRUD basiques",
        "Typecheck passe"
      ],
      "files": ["src/infrastructure/database/migrations/", "src/lib/types/real-estate.ts", "src/infrastructure/repositories/RealEstateRepository.ts"],
      "priority": 2,
      "passes": true,
      "notes": "Tables: entities (person/sci/joint), entity_shares, properties, property_ownership, loans, loan_responsibility, property_charges"
    },
    {
      "id": "US-011",
      "title": "Import données initiales",
      "description": "Créer script d'import pour les entités (Mathieu, Ninon, SCI IMANISA) et le Bien 1 (Rueil)",
      "dependsOn": ["US-010"],
      "acceptanceCriteria": [
        "Créer script src/scripts/seed-real-estate.ts",
        "Insérer entités: Mathieu (person, yellow), Ninon (person, pink), SCI IMANISA (sci, siren 989290879)",
        "Insérer parts SCI: 500 parts Mathieu (50%), 500 parts Ninon (50%)",
        "Insérer Bien 1: Appartement République Rueil (63.45m², DPE E, achat 375000€)",
        "Insérer prêt: CM Challans, 392621€ à 1.09%, mensualité 1495.73€, CRD 331994.82€",
        "Insérer propriété: 100% Mathieu depuis 2022-05-13 (partition)"
      ],
      "files": ["src/scripts/seed-real-estate.ts"],
      "priority": 3,
      "passes": true,
      "notes": "Données complètes dans tasks/prd-phase-1-immobilier.md section Données de référence"
    },
    {
      "id": "US-012",
      "title": "API Patrimoine Immobilier",
      "description": "Créer les endpoints API pour récupérer les données immobilières",
      "dependsOn": ["US-010"],
      "acceptanceCriteria": [
        "GET /api/real-estate/summary retourne {total_value, total_debt, net_equity}",
        "GET /api/real-estate/properties retourne liste des biens avec infos prêt associé",
        "GET /api/real-estate/properties/[id] retourne détail bien + prêt + propriétaires",
        "Typecheck passe"
      ],
      "files": ["src/routes/api/real-estate/"],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Dashboard Patrimoine Immobilier",
      "description": "Créer la page principale affichant le résumé du patrimoine immobilier",
      "dependsOn": ["US-012"],
      "acceptanceCriteria": [
        "Créer route /immobilier avec page.svelte et page.server.ts",
        "Afficher 3 KPIs: Valeur totale, Dette totale, Equity nette",
        "Afficher liste des biens avec PropertyCard (nom, adresse, surface, valeur, CRD)",
        "Clic sur PropertyCard navigue vers /immobilier/[id]",
        "Ajouter lien Immobilier dans la navigation"
      ],
      "files": ["src/routes/immobilier/", "src/lib/components/real-estate/"],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Page Détail Bien",
      "description": "Créer la page de détail d'un bien immobilier",
      "dependsOn": ["US-013"],
      "acceptanceCriteria": [
        "Créer route /immobilier/[id] avec page.svelte et page.server.ts",
        "Section Informations: adresse, surface, pièces, DPE, copropriété",
        "Section Valeur: prix achat, valeur actuelle, plus/moins value",
        "Section Prêt: banque, taux, emprunté, remboursé, restant, mensualité",
        "Section Propriété: propriétaires avec pourcentage",
        "Bouton retour vers /immobilier"
      ],
      "files": ["src/routes/immobilier/[id]/"],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Tableau d'Amortissement",
      "description": "Calculer et afficher le tableau d'amortissement d'un prêt",
      "dependsOn": ["US-014"],
      "acceptanceCriteria": [
        "Créer fonction calculateAmortizationSchedule(loan) dans src/lib/utils/loan-calculator.ts",
        "Retourne array de {date, payment, principal, interest, balance}",
        "Créer composant AmortizationTable.svelte",
        "Afficher tableau avec colonnes: Date, Mensualité, Capital, Intérêts, Restant",
        "Highlight du mois actuel",
        "Intégrer dans page détail bien"
      ],
      "files": ["src/lib/utils/loan-calculator.ts", "src/lib/components/real-estate/AmortizationTable.svelte"],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-100",
      "title": "Domain: DataSource et CSVParser abstrait",
      "description": "Créer le domaine pour les sources de données bancaires avec architecture extensible pour les parsers CSV",
      "dependsOn": ["US-000"],
      "acceptanceCriteria": [
        "Créer src/domain/import/DataSource.ts - entité représentant une source (nom, type, owner, url, format)",
        "Créer src/domain/import/DataSourceType.ts - enum (CHECKING, SAVINGS, LIVRET_A, etc.)",
        "Créer src/domain/import/CSVParser.ts - interface abstraite avec parse(content: string): ParsedTransaction[]",
        "Créer src/domain/import/ParsedTransaction.ts - DTO intermédiaire (date, amount, description, rawCategory?, balance?)",
        "Créer src/domain/import/DataSourceRepository.ts - interface repository",
        "Typecheck passe"
      ],
      "files": ["src/domain/import/"],
      "priority": 100,
      "passes": true,
      "notes": "Architecture DDD: le parser est un service de domaine, chaque banque implémente l'interface"
    },
    {
      "id": "US-101",
      "title": "Infrastructure: DataSourceRepository SQLite",
      "description": "Implémenter le repository et la table data_sources",
      "dependsOn": ["US-100"],
      "acceptanceCriteria": [
        "Ajouter table data_sources dans schema.sql (id, name, type, owner_entity_id, url, format, parser_key)",
        "Créer src/infrastructure/repositories/SqliteDataSourceRepository.ts",
        "CRUD complet: findAll, findById, save, delete",
        "Typecheck passe"
      ],
      "files": ["src/infrastructure/database/schema.sql", "src/infrastructure/repositories/SqliteDataSourceRepository.ts"],
      "priority": 101,
      "passes": true,
      "notes": "owner_entity_id référence entities(id) pour lier à Mathieu/Ninon/SCI"
    },
    {
      "id": "US-102",
      "title": "Parser: Crédit Mutuel CSV",
      "description": "Implémenter le parser CSV pour Crédit Mutuel",
      "dependsOn": ["US-100"],
      "acceptanceCriteria": [
        "Créer src/infrastructure/parsers/CreditMutuelParser.ts implémentant CSVParser",
        "Parser le format: Date;Date de valeur;Débit;Crédit;Libellé;Solde",
        "Gérer encoding Latin-1, séparateur ;, dates DD/MM/YYYY, montants avec virgule",
        "Fusionner Débit/Crédit en un seul amount signé",
        "Typecheck passe"
      ],
      "files": ["src/infrastructure/parsers/CreditMutuelParser.ts"],
      "priority": 102,
      "passes": true,
      "notes": "Format: Date;Date de valeur;Débit;Crédit;Libellé;Solde - encoding Latin-1"
    },
    {
      "id": "US-103",
      "title": "Parser: Caisse d'Épargne Particulier CSV",
      "description": "Implémenter le parser CSV pour Caisse d'Épargne (comptes particuliers)",
      "dependsOn": ["US-100"],
      "acceptanceCriteria": [
        "Créer src/infrastructure/parsers/CaisseEpargneParser.ts implémentant CSVParser",
        "Parser le format: Date de comptabilisation;Libelle simplifie;Libelle operation;Reference;Informations complementaires;Type operation;Categorie;Sous categorie;Debit;Credit;Date operation;Date de valeur;Pointage operation",
        "Extraire catégorie CE pour mapping futur",
        "Gérer encoding UTF-8, séparateur ;, dates DD/MM/YYYY",
        "Typecheck passe"
      ],
      "files": ["src/infrastructure/parsers/CaisseEpargneParser.ts"],
      "priority": 103,
      "passes": true,
      "notes": "Format riche avec catégorisation native CE à conserver"
    },
    {
      "id": "US-104",
      "title": "Parser: Caisse d'Épargne Entreprise CSV",
      "description": "Implémenter le parser CSV pour Caisse d'Épargne (comptes entreprise/SCI)",
      "dependsOn": ["US-100"],
      "acceptanceCriteria": [
        "Créer src/infrastructure/parsers/CaisseEpargneEntrepriseParser.ts implémentant CSVParser",
        "Parser le format: Date comptable;Libelle simplifie;Reference;Informations complementaires;Type operation;Debit;Credit;Date operation;Date de valeur;Pointage",
        "Gérer différence avec format particulier (pas de Categorie/Sous categorie, Pointage en Oui/Non)",
        "Typecheck passe"
      ],
      "files": ["src/infrastructure/parsers/CaisseEpargneEntrepriseParser.ts"],
      "priority": 104,
      "passes": true,
      "notes": "Format entreprise légèrement différent du format particulier"
    },
    {
      "id": "US-105",
      "title": "Parser: Boursorama CSV",
      "description": "Implémenter le parser CSV pour Boursorama",
      "dependsOn": ["US-100"],
      "acceptanceCriteria": [
        "Créer src/infrastructure/parsers/BoursoramaParser.ts implémentant CSVParser",
        "Parser le format: dateOp;dateVal;label;category;categoryParent;supplierFound;amount;comment;accountNum;accountLabel;accountbalance",
        "Gérer encoding UTF-8 BOM, séparateur ;, dates YYYY-MM-DD, montants avec virgule",
        "Extraire label court depuis format 'Court | Long'",
        "Typecheck passe"
      ],
      "files": ["src/infrastructure/parsers/BoursoramaParser.ts"],
      "priority": 105,
      "passes": true,
      "notes": "Format avec dates ISO et catégorisation Bourso"
    },
    {
      "id": "US-106",
      "title": "Application: ImportTransactionsUseCase",
      "description": "Créer le use case d'import de transactions depuis un fichier CSV",
      "dependsOn": ["US-102", "US-103", "US-104", "US-105"],
      "acceptanceCriteria": [
        "Créer src/application/import/ImportTransactionsUseCase.ts",
        "Injecter le bon parser selon dataSource.parserKey via ParserFactory",
        "Créer src/application/import/ParserFactory.ts pour instancier le parser approprié",
        "Dédupliquer: ne pas réimporter les transactions existantes (même date+montant+description)",
        "Retourner {imported: number, skipped: number, errors: string[]}",
        "Typecheck passe"
      ],
      "files": ["src/application/import/ImportTransactionsUseCase.ts", "src/application/import/ParserFactory.ts"],
      "priority": 106,
      "passes": true,
      "notes": "Le use case orchestre: parse CSV → dédupe → save transactions"
    },
    {
      "id": "US-107",
      "title": "API: Endpoints Import",
      "description": "Créer les endpoints API pour l'import de données",
      "dependsOn": ["US-106", "US-101"],
      "acceptanceCriteria": [
        "POST /api/import/csv - upload fichier CSV, params: dataSourceId → retourne {imported, skipped, errors}",
        "GET /api/data-sources - liste toutes les sources configurées",
        "GET /api/data-sources/[id] - détail d'une source",
        "Typecheck passe"
      ],
      "files": ["src/routes/api/import/", "src/routes/api/data-sources/"],
      "priority": 107,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-108",
      "title": "Seed: Configurer les 7 sources bancaires",
      "description": "Insérer les sources de données bancaires en base",
      "dependsOn": ["US-101"],
      "acceptanceCriteria": [
        "Créer src/scripts/seed-data-sources.ts",
        "Insérer: CM Mathieu (credit_mutuel, Mathieu, https://www.creditmutuel.fr/cmo/fr/banque/compte/telechargement.cgi?_tabi=C&_pid=MvtsMainPage)",
        "Insérer: CE Perso (caisse_epargne, Mathieu, https://www.caisse-epargne.fr/espace-client/compte)",
        "Insérer: CE Joint (caisse_epargne, Joint Mathieu+Ninon, https://www.caisse-epargne.fr/espace-client/compte)",
        "Insérer: CE Livret A (caisse_epargne, Mathieu, https://www.caisse-epargne.fr/espace-client/compte)",
        "Insérer: CE SCI (caisse_epargne_entreprise, SCI IMANISA, https://www.caisse-epargne.fr/espace-entreprise/banque-en-ligne/web/mes-comptes/7504f782-7d5f-4f6e-bf36-ad3e9ea14c6d/transactions)",
        "Insérer: Boursorama Isaac CC (boursorama, Isaac, https://clients.boursobank.com/operations/generate/2f4a1a0857e9fc898dee14c09ad809d6)",
        "Insérer: Boursorama Isaac Livret A (boursorama, Isaac, https://clients.boursobank.com/operations/generate/a93b9b73a2e51cd62db59a0818d36cac)"
      ],
      "files": ["src/scripts/seed-data-sources.ts"],
      "priority": 108,
      "passes": true,
      "notes": "Isaac = enfant, créer entité Isaac (person, blue?) avant"
    },
    {
      "id": "US-109",
      "title": "UI: Page Import avec Sync Manuel",
      "description": "Créer l'interface d'import avec bouton sync et drag & drop",
      "dependsOn": ["US-107", "US-108"],
      "acceptanceCriteria": [
        "Créer route /import avec page.svelte et page.server.ts",
        "Afficher liste des sources groupées par propriétaire avec nom, type, dernière sync",
        "Bouton 'Ouvrir tous les liens' → ouvre chaque URL source dans un nouvel onglet",
        "Zone drag & drop par source pour uploader le CSV",
        "Afficher résultat import (X importées, Y ignorées, erreurs)",
        "Ajouter lien Import dans la navigation"
      ],
      "files": ["src/routes/import/", "src/lib/components/import/"],
      "priority": 109,
      "passes": true,
      "notes": "Flow: clic sync → onglets s'ouvrent → user télécharge → drop fichiers → import"
    },
    {
      "id": "US-002",
      "title": "Refacto: Renommer repositories (supprimer préfixe Sqlite)",
      "description": "Renommer tous les SqliteXxxRepository en XxxRepository car on utilise Drizzle maintenant",
      "dependsOn": ["US-001"],
      "acceptanceCriteria": [
        "Renommer SqliteAccountRepository.ts → AccountRepository.ts",
        "Renommer SqliteBankRepository.ts → BankRepository.ts",
        "Renommer SqliteTransactionRepository.ts → TransactionRepository.ts",
        "Renommer SqliteUserRepository.ts → UserRepository.ts",
        "Renommer SqliteDataSourceRepository.ts → DataSourceRepository.ts (si existe)",
        "Mettre à jour tous les imports",
        "Supprimer les interfaces repository du domain si elles dupliquent (garder une seule source de vérité)",
        "Typecheck passe"
      ],
      "files": ["src/infrastructure/repositories/"],
      "priority": 3,
      "passes": true,
      "notes": "Convention DDD: le nom du repository ne doit pas exposer l'implémentation technique"
    },
    {
      "id": "US-200",
      "title": "Domain: InvestmentPosition et InvestmentTransaction",
      "description": "Créer le domaine pour les positions et transactions d'investissement",
      "dependsOn": ["US-001"],
      "acceptanceCriteria": [
        "Créer src/domain/investment/InvestmentPosition.ts - entité (sourceId, symbol, isin?, quantity, avgBuyPrice, currentPrice, gainLoss, gainLossPercent)",
        "Créer src/domain/investment/InvestmentTransaction.ts - entité (sourceId, date, symbol, type buy/sell, quantity, pricePerUnit, totalAmount, fee)",
        "Créer src/domain/investment/InvestmentSource.ts - entité (nom, type PEA/AV/CRYPTO, owner, url, format)",
        "Créer src/domain/investment/InvestmentSourceType.ts - enum (PEA, ASSURANCE_VIE, CRYPTO, CTO)",
        "Créer src/domain/investment/InvestmentParser.ts - interface abstraite avec parsePositions() et parseTransactions()",
        "Typecheck passe"
      ],
      "files": ["src/domain/investment/"],
      "priority": 200,
      "passes": true,
      "notes": "Positions = snapshot valorisation, Transactions = historique achats/ventes"
    },
    {
      "id": "US-201",
      "title": "Infrastructure: Tables et Repository Investissements",
      "description": "Créer les tables et repository pour les investissements",
      "dependsOn": ["US-200"],
      "acceptanceCriteria": [
        "Ajouter table investment_sources dans schema Drizzle (id, name, type, owner_entity_id, url, format, parser_key)",
        "Ajouter table investment_positions (id, source_id, symbol, isin, quantity, avg_buy_price, current_price, current_value, gain_loss, gain_loss_percent, last_updated)",
        "Ajouter table investment_transactions (id, source_id, date, symbol, type, quantity, price_per_unit, total_amount, fee)",
        "Créer src/infrastructure/repositories/InvestmentRepository.ts",
        "Typecheck passe"
      ],
      "files": ["src/infrastructure/database/schema/", "src/infrastructure/repositories/InvestmentRepository.ts"],
      "priority": 201,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-202",
      "title": "Parser: Bourse Direct XLSX (PEA)",
      "description": "Implémenter le parser XLSX pour Bourse Direct",
      "dependsOn": ["US-200"],
      "acceptanceCriteria": [
        "Créer src/infrastructure/parsers/BourseDirectParser.ts implémentant InvestmentParser",
        "Parser le format XLSX: Nom,ISIN,Cours,Devise,Variation Veille %,Quantité,PRU (EUR),+/- value (EUR),+/- value %,Valorisation (EUR),Réglement,MIC,Marché",
        "Retourner InvestmentPosition[] avec symbol, isin, quantity, avgBuyPrice, currentPrice, gainLoss, gainLossPercent",
        "Gérer encoding UTF-8, format nombres avec virgule",
        "Typecheck passe"
      ],
      "files": ["src/infrastructure/parsers/BourseDirectParser.ts"],
      "priority": 202,
      "passes": false,
      "notes": "Format positions PEA - URL: https://www.boursedirect.fr/fr/mon-compte/portefeuilles"
    },
    {
      "id": "US-203",
      "title": "Parser: Linxea XLSX (Assurance-vie)",
      "description": "Implémenter le parser XLSX pour Linxea",
      "dependsOn": ["US-200"],
      "acceptanceCriteria": [
        "Créer src/infrastructure/parsers/LinxeaParser.ts implémentant InvestmentParser",
        "Parser le format XLSX: Placement,N° Contrat,Titulaire,Produit,Catégorie,Sous-catégorie,Nom du support,ISIN,Nbre de parts,Dernière cotation,Date,Somme en Compte,Plus ou Moins Value,Prix de Revient Moyen,Perf.%...",
        "Retourner InvestmentPosition[] avec symbol (Nom du support), isin, quantity, avgBuyPrice (PRU), currentPrice, gainLoss, gainLossPercent",
        "Typecheck passe"
      ],
      "files": ["src/infrastructure/parsers/LinxeaParser.ts"],
      "priority": 203,
      "passes": false,
      "notes": "Format positions AV - URL: https://espaceclient.linxea.com/epargne/contrat/{id}"
    },
    {
      "id": "US-204",
      "title": "Parser: Binance XLSX (Crypto)",
      "description": "Implémenter le parser XLSX pour Binance historique achats",
      "dependsOn": ["US-200"],
      "acceptanceCriteria": [
        "Créer src/infrastructure/parsers/BinanceParser.ts implémentant InvestmentParser",
        "Parser le format XLSX: Date(UTC+1),Method,Spend Amount,Receive Amount,Fee,Price,Status,Transaction ID",
        "Filtrer Status=Successful uniquement",
        "Retourner InvestmentTransaction[] avec date, symbol (BTC/ETH extrait de Receive Amount), type=buy, quantity, pricePerUnit, totalAmount, fee",
        "Extraire le symbol depuis 'Receive Amount' (ex: '0.00132001 BTC' → symbol='BTC', quantity=0.00132001)",
        "Typecheck passe"
      ],
      "files": ["src/infrastructure/parsers/BinanceParser.ts"],
      "priority": 204,
      "passes": false,
      "notes": "Format transactions crypto - URL: https://www.binance.com/en/my/wallet/exchange/buysell-history"
    },
    {
      "id": "US-205",
      "title": "Service: Calcul positions crypto depuis transactions",
      "description": "Calculer les positions crypto agrégées depuis l'historique des transactions",
      "dependsOn": ["US-204"],
      "acceptanceCriteria": [
        "Créer src/application/investment/CalculateCryptoPositionsUseCase.ts",
        "Agréger les transactions par symbol pour calculer: quantity totale, PRU moyen pondéré",
        "Intégrer prix actuel via API CoinGecko (GET /simple/price?ids=bitcoin,ethereum&vs_currencies=eur)",
        "Calculer currentValue, gainLoss, gainLossPercent",
        "Retourner InvestmentPosition[] pour chaque crypto détenue",
        "Typecheck passe"
      ],
      "files": ["src/application/investment/CalculateCryptoPositionsUseCase.ts"],
      "priority": 205,
      "passes": false,
      "notes": "PRU moyen = somme(totalAmount) / somme(quantity) pour chaque symbol"
    },
    {
      "id": "US-206",
      "title": "Application: ImportInvestmentsUseCase",
      "description": "Créer le use case d'import des données d'investissement",
      "dependsOn": ["US-202", "US-203", "US-204", "US-201"],
      "acceptanceCriteria": [
        "Créer src/application/investment/ImportInvestmentsUseCase.ts",
        "Créer src/application/investment/InvestmentParserFactory.ts",
        "Pour PEA/AV: parser → upsert positions (remplacer les anciennes)",
        "Pour Crypto: parser → append transactions + recalculer positions",
        "Retourner {positions: number, transactions: number, errors: string[]}",
        "Typecheck passe"
      ],
      "files": ["src/application/investment/ImportInvestmentsUseCase.ts", "src/application/investment/InvestmentParserFactory.ts"],
      "priority": 206,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-207",
      "title": "Seed: Configurer les 3 sources investissement",
      "description": "Insérer les sources d'investissement en base",
      "dependsOn": ["US-201"],
      "acceptanceCriteria": [
        "Enrichir src/scripts/seed-data-sources.ts ou créer seed-investment-sources.ts",
        "Insérer: PEA Bourse Direct (pea, Mathieu, https://www.boursedirect.fr/fr/mon-compte/portefeuilles, bourse_direct)",
        "Insérer: Linxea AV (assurance_vie, Mathieu, https://espaceclient.linxea.com/epargne/contrat/6695e318-99ab-462b-8bc2-51c083225c13, linxea)",
        "Insérer: Binance (crypto, Mathieu, https://www.binance.com/en/my/wallet/exchange/buysell-history, binance)"
      ],
      "files": ["src/scripts/seed-data-sources.ts"],
      "priority": 207,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-208",
      "title": "API: Endpoints Investissements",
      "description": "Créer les endpoints API pour les investissements",
      "dependsOn": ["US-206"],
      "acceptanceCriteria": [
        "POST /api/investments/import - upload fichier XLSX, params: sourceId → retourne {positions, transactions, errors}",
        "GET /api/investments/positions - liste toutes les positions avec valorisation",
        "GET /api/investments/summary - retourne {total_invested, current_value, total_gain_loss, total_gain_loss_percent}",
        "GET /api/investments/sources - liste les sources d'investissement",
        "Typecheck passe"
      ],
      "files": ["src/routes/api/investments/"],
      "priority": 208,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-209",
      "title": "UI: Page Investissements",
      "description": "Créer l'interface de visualisation des investissements",
      "dependsOn": ["US-208", "US-207"],
      "acceptanceCriteria": [
        "Créer route /investissements avec page.svelte et page.server.ts",
        "Afficher KPIs: Total investi, Valorisation actuelle, +/- value globale (€ et %)",
        "Afficher liste des positions groupées par source (PEA, AV, Crypto)",
        "Pour chaque position: symbol, quantité, PRU, cours actuel, valorisation, +/- value",
        "Code couleur: vert si gain, rouge si perte",
        "Zone import avec drag & drop par source",
        "Ajouter lien Investissements dans la navigation"
      ],
      "files": ["src/routes/investissements/", "src/lib/components/investments/"],
      "priority": 209,
      "passes": false,
      "notes": "Afficher clairement la performance de chaque ligne et du portefeuille global"
    },
    {
      "id": "US-900",
      "title": "Setup: Configuration Testing (Vitest + Testcontainers)",
      "description": "Configurer l'environnement de tests unitaires et d'intégration",
      "dependsOn": ["US-001"],
      "acceptanceCriteria": [
        "Installer vitest, @testing-library/svelte, testcontainers",
        "Configurer vitest.config.ts avec alias paths",
        "Créer src/tests/setup.ts pour initialisation globale",
        "Créer src/tests/fixtures/ pour les données de test",
        "Créer helper src/tests/utils/createTestDb.ts avec testcontainers pour DB isolée",
        "npm run test fonctionne"
      ],
      "files": ["vitest.config.ts", "src/tests/", "package.json"],
      "priority": 900,
      "passes": false,
      "notes": "Testcontainers pour isoler les tests d'intégration avec une vraie DB. IMPORTANT: Ces US de tests servent à valider les US précédentes. Si un test échoue (bug code, UI cassée, etc.), il faut: 1) Identifier l'US source du bug, 2) Corriger le bug dans le code concerné, 3) Relancer les tests, 4) Boucler jusqu'à ce que TOUS les tests passent. Ne JAMAIS marquer une US test comme 'passes: true' tant que les tests échouent. Les tests sont le filet de sécurité final."
    },
    {
      "id": "US-901",
      "title": "Tests: Domain Layer (unitaires)",
      "description": "Tester exhaustivement la couche domaine - c'est le coeur du système",
      "dependsOn": ["US-900"],
      "acceptanceCriteria": [
        "Tests pour chaque entité domain: Transaction, Account, Bank, DataSource, InvestmentPosition, InvestmentTransaction",
        "Tests pour les value objects: Money, UniqueId, Result",
        "Tests pour les enums et leurs validations",
        "Couvrir les cas nominaux ET les cas d'erreur (validation, edge cases)",
        "100% coverage sur src/domain/",
        "Un seul toMatchInlineSnapshot par test",
        "npm run test passe"
      ],
      "files": ["src/domain/**/*.test.ts"],
      "priority": 901,
      "passes": false,
      "notes": "Le domaine doit être testé au maximum - c'est la logique métier pure"
    },
    {
      "id": "US-902",
      "title": "Tests: Parsers (unitaires avec fixtures)",
      "description": "Tester tous les parsers CSV/XLSX avec des données d'exemple réelles",
      "dependsOn": ["US-900", "US-102", "US-103", "US-104", "US-105", "US-202", "US-203", "US-204"],
      "acceptanceCriteria": [
        "Créer fixtures CSV dans src/tests/fixtures/csv/ avec données anonymisées pour chaque banque",
        "Créer fixtures XLSX dans src/tests/fixtures/xlsx/ pour Bourse Direct, Linxea, Binance",
        "Test CreditMutuelParser: parse fixture → vérifie structure output, dates, montants signés",
        "Test CaisseEpargneParser: parse fixture → vérifie catégories extraites",
        "Test CaisseEpargneEntrepriseParser: parse fixture → vérifie format entreprise",
        "Test BoursoramaParser: parse fixture → vérifie dates ISO, label court/long",
        "Test BourseDirectParser: parse fixture → vérifie positions avec PRU, +/- value",
        "Test LinxeaParser: parse fixture → vérifie positions AV",
        "Test BinanceParser: parse fixture → vérifie transactions, extraction symbol/quantity",
        "Un seul toMatchInlineSnapshot par test pour vérifier la structure",
        "npm run test passe"
      ],
      "files": ["src/infrastructure/parsers/*.test.ts", "src/tests/fixtures/"],
      "priority": 902,
      "passes": false,
      "notes": "Fixtures basées sur les formats réels fournis par l'utilisateur"
    },
    {
      "id": "US-903",
      "title": "Tests: Repositories (intégration avec Testcontainers)",
      "description": "Tester les repositories avec une vraie base de données",
      "dependsOn": ["US-900"],
      "acceptanceCriteria": [
        "Tests d'intégration pour chaque repository: Account, Bank, Transaction, DataSource, Investment",
        "Utiliser testcontainers pour créer une DB SQLite isolée par test",
        "Tester CRUD complet: create, read, update, delete",
        "Tester les requêtes complexes (findByBankId, findByDateRange, etc.)",
        "Un seul toMatchInlineSnapshot par test",
        "npm run test passe"
      ],
      "files": ["src/infrastructure/repositories/*.test.ts"],
      "priority": 903,
      "passes": false,
      "notes": "Testcontainers garantit l'isolation entre tests"
    },
    {
      "id": "US-904",
      "title": "Tests: Use Cases (intégration)",
      "description": "Tester les use cases avec mocks ou testcontainers",
      "dependsOn": ["US-903"],
      "acceptanceCriteria": [
        "Test ImportTransactionsUseCase: mock parser + real DB → vérifie import et déduplication",
        "Test ImportInvestmentsUseCase: mock parser + real DB → vérifie upsert positions",
        "Test CalculateCryptoPositionsUseCase: mock API CoinGecko → vérifie calcul PRU et valorisation",
        "Un seul toMatchInlineSnapshot par test",
        "npm run test passe"
      ],
      "files": ["src/application/**/*.test.ts"],
      "priority": 904,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-905",
      "title": "Tests: API Routes (intégration)",
      "description": "Tester les endpoints API avec des requêtes HTTP réelles",
      "dependsOn": ["US-903"],
      "acceptanceCriteria": [
        "Utiliser @sveltejs/kit testing utilities ou supertest",
        "Test GET /api/data-sources → vérifie structure response",
        "Test POST /api/import/csv → vérifie import avec fixture CSV",
        "Test GET /api/investments/positions → vérifie liste positions",
        "Test GET /api/investments/summary → vérifie calculs agrégés",
        "Test GET /api/real-estate/summary → vérifie KPIs immobilier",
        "Test GET /api/real-estate/properties → vérifie liste biens",
        "Un seul toMatchInlineSnapshot par test pour vérifier structure JSON",
        "npm run test passe"
      ],
      "files": ["src/routes/api/**/*.test.ts"],
      "priority": 905,
      "passes": false,
      "notes": "Tests d'intégration HTTP - vérifient le contrat API"
    },
    {
      "id": "US-910",
      "title": "Setup: Configuration E2E (Playwright)",
      "description": "Configurer Playwright pour les tests end-to-end",
      "dependsOn": ["US-900"],
      "acceptanceCriteria": [
        "Installer @playwright/test",
        "Configurer playwright.config.ts avec baseURL localhost:5173",
        "Créer e2e/ folder pour les tests",
        "Créer e2e/fixtures/ pour seed data E2E",
        "Script npm run test:e2e qui lance dev server + tests",
        "npm run test:e2e fonctionne (même si 0 tests)"
      ],
      "files": ["playwright.config.ts", "e2e/", "package.json"],
      "priority": 910,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-911",
      "title": "E2E: Smoke test avec Agent Browser",
      "description": "Vérifier que l'app démarre et que les pages principales sont accessibles",
      "dependsOn": ["US-910"],
      "acceptanceCriteria": [
        "Test: page d'accueil se charge sans erreur",
        "Test: navigation vers /immobilier fonctionne",
        "Test: navigation vers /investissements fonctionne",
        "Test: navigation vers /import fonctionne",
        "Vérifier absence d'erreurs console JavaScript",
        "npm run test:e2e passe"
      ],
      "files": ["e2e/smoke.test.ts"],
      "priority": 911,
      "passes": false,
      "notes": "Smoke tests = vérifier que l'app ne plante pas"
    },
    {
      "id": "US-912",
      "title": "E2E: Tests Import bancaire",
      "description": "Tester le flow complet d'import de données bancaires",
      "dependsOn": ["US-911", "US-109"],
      "acceptanceCriteria": [
        "Test: aller sur /import, vérifier liste des sources affichée",
        "Test: drag & drop un fichier CSV fixture sur une source",
        "Test: vérifier message de succès avec nombre de transactions importées",
        "Test: vérifier que les transactions apparaissent dans la liste",
        "npm run test:e2e passe"
      ],
      "files": ["e2e/import.test.ts"],
      "priority": 912,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-913",
      "title": "E2E: Tests Immobilier",
      "description": "Tester le flow de consultation du patrimoine immobilier",
      "dependsOn": ["US-911", "US-015"],
      "acceptanceCriteria": [
        "Test: aller sur /immobilier, vérifier KPIs affichés (valeur, dette, equity)",
        "Test: cliquer sur un bien, vérifier page détail",
        "Test: vérifier tableau d'amortissement présent et scrollable",
        "Test: vérifier infos bien (adresse, surface, DPE)",
        "npm run test:e2e passe"
      ],
      "files": ["e2e/immobilier.test.ts"],
      "priority": 913,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-914",
      "title": "E2E: Tests Investissements",
      "description": "Tester le flow de consultation et import des investissements",
      "dependsOn": ["US-911", "US-209"],
      "acceptanceCriteria": [
        "Test: aller sur /investissements, vérifier KPIs (investi, valorisation, +/- value)",
        "Test: vérifier positions groupées par source",
        "Test: vérifier couleurs gain (vert) / perte (rouge)",
        "Test: drag & drop fichier XLSX fixture, vérifier mise à jour positions",
        "npm run test:e2e passe"
      ],
      "files": ["e2e/investissements.test.ts"],
      "priority": 914,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-300",
      "title": "PWA: Configuration Progressive Web App",
      "description": "Configurer l'app comme PWA installable sur mobile",
      "dependsOn": ["US-013"],
      "acceptanceCriteria": [
        "Créer static/manifest.json avec name, short_name, icons, start_url, display: standalone, theme_color, background_color",
        "Créer icônes PWA: 192x192 et 512x512 (maskable)",
        "Ajouter <link rel='manifest'> dans app.html",
        "Ajouter <meta name='theme-color'> dynamique selon dark/light mode",
        "Ajouter <meta name='apple-mobile-web-app-capable' content='yes'>",
        "Ajouter apple-touch-icon pour iOS",
        "L'app est installable sur mobile (Chrome/Safari)"
      ],
      "files": ["static/manifest.json", "src/app.html", "static/icons/"],
      "priority": 300,
      "passes": false,
      "notes": "PWA permet d'installer l'app sur l'écran d'accueil mobile"
    },
    {
      "id": "US-301",
      "title": "UI: Layout responsive mobile-first",
      "description": "Refactorer le layout pour être mobile-first et respecter Vercel Web Interface Guidelines",
      "dependsOn": ["US-300"],
      "acceptanceCriteria": [
        "Appliquer mobile-first: styles de base pour mobile, media queries pour desktop",
        "Navigation: bottom nav sur mobile, sidebar sur desktop",
        "Touch targets ≥44px sur mobile (boutons, liens, zones cliquables)",
        "Input font-size ≥16px pour éviter zoom iOS",
        "touch-action: manipulation sur les éléments interactifs",
        "Respecter safe areas avec env(safe-area-inset-*)",
        "Vérifier sur viewport 375px (iPhone SE) et 428px (iPhone 14 Pro Max)",
        "Typecheck passe"
      ],
      "files": ["src/routes/+layout.svelte", "src/lib/components/Navigation.svelte", "src/app.css"],
      "priority": 301,
      "passes": false,
      "notes": "Suivre Vercel Web Interface Guidelines - run /web-interface-guidelines sur chaque composant UI"
    },
    {
      "id": "US-302",
      "title": "UI: Dark mode avec color-scheme",
      "description": "Implémenter le dark mode correctement selon les guidelines",
      "dependsOn": ["US-301"],
      "acceptanceCriteria": [
        "Ajouter color-scheme: dark sur <html> quand dark mode actif",
        "Meta theme-color dynamique selon le mode",
        "Palette de couleurs accessible (contraste APCA)",
        "Native <select> avec background-color et color explicites (fix Windows)",
        "Toggle dark/light mode persisté en localStorage",
        "Respecter prefers-color-scheme du système par défaut"
      ],
      "files": ["src/app.html", "src/app.css", "src/lib/stores/theme.ts"],
      "priority": 302,
      "passes": false,
      "notes": "Dark mode = color-scheme: dark sur html + theme-color meta"
    },
    {
      "id": "US-303",
      "title": "UI: Accessibilité et focus management",
      "description": "Assurer l'accessibilité clavier et lecteur d'écran",
      "dependsOn": ["US-301"],
      "acceptanceCriteria": [
        "Focus visible avec :focus-visible sur tous les éléments interactifs",
        "Skip to content link en haut de page",
        "Hiérarchie de headings correcte (h1 > h2 > h3)",
        "aria-label sur les boutons icon-only",
        "aria-live polite pour les toasts et notifications",
        "Navigation clavier complète (Tab, Enter, Escape)",
        "Pas de outline: none sans remplacement visible"
      ],
      "files": ["src/app.css", "src/lib/components/"],
      "priority": 303,
      "passes": false,
      "notes": "Suivre WAI-ARIA APG patterns"
    },
    {
      "id": "US-304",
      "title": "UI: Formulaires selon guidelines",
      "description": "Refactorer les formulaires pour respecter les best practices",
      "dependsOn": ["US-301"],
      "acceptanceCriteria": [
        "Inputs avec autocomplete et name corrects",
        "inputmode approprié (numeric, email, tel, etc.)",
        "Placeholders avec … et exemple de format",
        "Validation inline à côté des champs, pas en alert",
        "Focus sur première erreur après submit",
        "Loading state sur boutons: spinner + label original",
        "Pas de blocage de paste sur les inputs",
        "Labels cliquables (label + input même hit target)"
      ],
      "files": ["src/lib/components/forms/"],
      "priority": 304,
      "passes": false,
      "notes": "Hydration-safe inputs, password manager compatible"
    },
    {
      "id": "US-305",
      "title": "UI: Animations respectueuses",
      "description": "Implémenter des animations performantes et accessibles",
      "dependsOn": ["US-301"],
      "acceptanceCriteria": [
        "Respecter prefers-reduced-motion (désactiver ou réduire)",
        "Animer uniquement transform et opacity (compositor-friendly)",
        "Jamais transition: all - lister les propriétés explicitement",
        "Animations interruptibles (pas d'autoplay bloquant)",
        "transform-origin correct pour les animations de scale/rotate"
      ],
      "files": ["src/app.css", "src/lib/components/"],
      "priority": 305,
      "passes": false,
      "notes": "Préférer CSS > Web Animations API > JS libraries"
    },
    {
      "id": "US-306",
      "title": "UI: Performance mobile",
      "description": "Optimiser les performances pour mobile",
      "dependsOn": ["US-301"],
      "acceptanceCriteria": [
        "Virtualiser les listes >50 items (transactions, positions)",
        "Lazy load images below the fold",
        "Dimensions explicites sur les images (éviter CLS)",
        "Preconnect aux CDN externes",
        "font-display: swap pour les fonts custom",
        "Tester avec CPU throttling 4x et réseau 3G",
        "Mutations (POST/PATCH/DELETE) <500ms"
      ],
      "files": ["src/lib/components/", "src/app.html"],
      "priority": 306,
      "passes": false,
      "notes": "Tester sur iOS Low Power Mode"
    },
    {
      "id": "US-307",
      "title": "UI: Pages mobile-optimized",
      "description": "Adapter toutes les pages pour une UX mobile optimale",
      "dependsOn": ["US-301", "US-109", "US-209", "US-015"],
      "acceptanceCriteria": [
        "Page /import: zones drop adaptées au mobile, boutons larges",
        "Page /immobilier: KPIs en stack vertical sur mobile, cards full-width",
        "Page /immobilier/[id]: sections collapsibles sur mobile",
        "Page /investissements: tableau scrollable horizontal avec sticky first column",
        "Tableau d'amortissement: scroll horizontal avec header sticky",
        "Navigation bottom bar avec icônes + labels courts"
      ],
      "files": ["src/routes/", "src/lib/components/"],
      "priority": 307,
      "passes": false,
      "notes": "Ninon utilisera principalement sur mobile"
    },
    {
      "id": "US-915",
      "title": "E2E: Tests Mobile viewport",
      "description": "Tester l'app sur viewport mobile",
      "dependsOn": ["US-911", "US-307"],
      "acceptanceCriteria": [
        "Configurer Playwright avec viewport mobile (375x667)",
        "Test: navigation bottom bar visible et fonctionnelle",
        "Test: touch targets ≥44px (vérifier avec getComputedStyle)",
        "Test: pas de scroll horizontal non voulu",
        "Test: formulaires utilisables sans zoom",
        "npm run test:e2e passe"
      ],
      "files": ["e2e/mobile.test.ts"],
      "priority": 915,
      "passes": false,
      "notes": "Viewport iPhone SE (375x667) comme baseline"
    }
  ]
}
