# Ralph Progress Log
# Project: Imanisa Finance
# Location: /Users/fr162241/Projects/imanisa-finance
# Started: Thu Jan 15 15:37:55 CET 2026
#
# This file is generated and maintained by Ralph.
# See: https://github.com/thecgaigroup/ralph-cc-loop
---

## Codebase Patterns
- **Drizzle ORM (preferred)**: Use `getDb()` from `@infrastructure/database/drizzle` for type-safe database access
- **Raw SQL (fallback)**: Use `execute(sql, args)` from `@infrastructure/database/turso` for complex queries
- Drizzle queries: `db.select().from(schema.table).where(eq(schema.table.column, value))`
- Drizzle types: `schema.tableName.$inferSelect` for row type, `$inferInsert` for insert
- All database operations are async - always await the execute calls
- Turso client supports both cloud (TURSO_URL + TURSO_AUTH_TOKEN) and local SQLite (DATABASE_PATH)
- Real estate module: types in `@lib/types/real-estate.ts`, repository in `@infrastructure/repositories/RealEstateRepository.ts`
- New real estate tables use `re_` prefix (re_properties, re_loans) to avoid collision with legacy tables
- Svelte 5 component props: `let { prop }: Props = $props()` (destructure with type annotation)
- Real estate components: `src/lib/components/real-estate/` with barrel export in index.ts
- Domain import module: `@domain/import` for DataSource, CSVParser, ParsedTransaction types
- Repository naming: `XxxRepositoryImpl` for implementation class in `@infrastructure/`, `XxxRepository` interface in `@domain/`
- CSV parsers: `src/infrastructure/parsers/` - each bank implements CSVParser interface, handles encoding/date/amount format differences
- Application layer: Use cases go in `src/application/{module}/` with ParserFactory pattern for extensibility
- ImportTransactionsUseCase: Links DataSource → Account via `linkedAccountId`, deduplicates on date+amount+description
- Investment domain module: `@domain/investment` for InvestmentSource, InvestmentPosition, InvestmentTransaction, InvestmentParser
- InvestmentParser interface: parsePositions() and parseTransactions() methods, content can be ArrayBuffer (XLSX) or string (CSV)
- **Mobile-first CSS**: Base styles for mobile, `@media (min-width: 769px)` for desktop
- **Navigation component**: `src/lib/components/Navigation.svelte` - mobile bottom nav, desktop sidebar
- **Touch optimization**: `touch-action: manipulation` on interactive elements, `min-height: 44px` for touch targets
- **iOS zoom prevention**: `font-size: max(16px, 1rem)` on inputs prevents zoom on focus
- **Safe areas**: Use `env(safe-area-inset-*)` with `max()` for notched device support
- **Accessibility**: `:focus-visible` for keyboard navigation, `aria-current="page"` on active nav items
- **Theme store**: `$lib/stores/theme` exports `theme` store with `toggle()`, `setTheme()`, `reset()` methods
- **Theme persistence**: localStorage key `imanisa-theme`, values: 'light', 'dark', 'system'
- **Theme CSS**: `:root, html.dark` for dark mode, `html.light` for light mode in tokens.css
- **Form components**: `$lib/components/forms` exports FormInput, FormSelect, Button with barrel export
- **Button loading state**: Use `loading` prop with SVG spinner, button shows `aria-busy="true"`
- **Svelte 5 derived**: Use `$derived.by(() => { ... })` for computed values needing function body
- **Test database**: Use `createTestDb()` from `@tests/utils` for in-memory SQLite test instances
- **Test fixtures**: Use `testFixtures.entity()`, `.user()`, `.bank()`, etc. for generating test data with unique IDs
- **Run tests**: `npm run test` (single run), `npm run test:watch` (watch mode), `npm run test:coverage` (with coverage)

---

## [Iteration 1] 2026-01-15 - US-000: Migration SQLite → Turso

### What was implemented
- Migrated from better-sqlite3 (synchronous) to @libsql/client (async) for Turso compatibility
- Created new `src/infrastructure/database/turso.ts` with async database client
- Migrated all 4 repositories (User, Bank, Account, Transaction) to async pattern
- Updated all page.server.ts files to use async database queries
- Updated API routes to use async database queries
- Added Turso environment variables to .env.example

### Files changed
- package.json, package-lock.json (deps: -better-sqlite3, +@libsql/client)
- src/infrastructure/database/turso.ts (new)
- src/infrastructure/database/connection.ts (re-export wrapper)
- src/infrastructure/database/repositories/*.ts (4 files)
- src/infrastructure/auth/users.ts
- src/routes/+page.server.ts
- src/routes/accounts/+page.server.ts
- src/routes/loans/+page.server.ts
- src/routes/investments/+page.server.ts
- src/routes/transactions/+page.server.ts
- src/routes/api/dashboard/+server.ts
- src/routes/api/auth/login/+server.ts
- src/routes/login/+page.server.ts
- .env.example

### Learnings for future iterations
- The @libsql/client returns Row objects that need double casting: `as unknown as YourType`
- All database functions became async - be sure to `await` all calls
- Schema initialization needs to split SQL statements and execute one at a time
- Local SQLite fallback uses `file:` protocol: `file:./data/imanisa.db`
- The `executeMany` function wraps libsql's `batch()` for multi-statement transactions
- Real estate tables use `re_` prefix (re_properties, re_loans) to avoid collision with legacy tables
- Use JSON.stringify/JSON.parse for array fields stored in TEXT columns (e.g., copro_lots)
- RealEstateRepository follows function-based pattern (not class-based) with explicit mappers

---

## [Iteration 2] 2026-01-15 - US-010: Schéma BDD Immobilier

### What was implemented
- Created comprehensive real estate database schema with 7 new tables:
  - `entities` - persons, SCI, joint ownership
  - `entity_shares` - SCI capital distribution
  - `re_properties` - detailed property tracking (enhanced from legacy)
  - `property_ownership` - ownership percentages and acquisition info
  - `re_loans` - enhanced loan tracking
  - `loan_responsibility` - who is responsible for loan
  - `property_charges` - recurring expenses
- Created TypeScript types for all entities with domain and row types
- Created RealEstateRepository with full CRUD operations and composite queries

### Files changed
- src/infrastructure/database/migrations/001_real_estate.sql (new)
- src/infrastructure/database/schema.sql (updated with new tables)
- src/lib/types/real-estate.ts (new)
- src/infrastructure/repositories/RealEstateRepository.ts (new)

### Learnings for future iterations
- New real estate tables use `re_` prefix to distinguish from legacy `properties` and `loans` tables
- The repository is at `src/infrastructure/repositories/` (not under `database/repositories/`)
- Property types: apartment, house, parking, land, commercial
- Property categories: primary_residence, rental_furnished, rental_unfurnished, secondary, sci
- Acquisition types: purchase, inheritance, donation, partition
- Charge types: copro, tax, insurance, maintenance, other

---

## [Iteration 3] 2026-01-15 - US-011: Import données initiales

### What was implemented
- Created seed script `src/scripts/seed-real-estate.ts` for initial real estate data
- Inserted 3 entities:
  - Mathieu (person, yellow)
  - Ninon (person, pink)
  - SCI IMANISA (sci, SIREN 989290879)
- Inserted SCI shares: 500 parts each for Mathieu and Ninon (50%/50%)
- Inserted Bien 1: Appartement République Rueil
  - 63.45m², 4 pièces, 2ème étage, DPE E
  - Copropriété "Les Nouveaux Martinets", lots 352+383
  - Valeur: 375 000 €
- Inserted loan: Prêt Modulimmo CM Challans
  - Principal: 392 621 €, taux 1.09%, durée 300 mois
  - Mensualité: 1 495.73 €, CRD: 331 994.82 €
- Inserted ownership: 100% Mathieu (partition 13/05/2022)
- Added npm script `seed:real-estate` to package.json

### Files changed
- src/scripts/seed-real-estate.ts (new)
- package.json (added seed:real-estate script)

### Learnings for future iterations
- Script uses `INSERT OR REPLACE` for idempotency - can be run multiple times safely
- Entity IDs: mathieu, ninon, sci-imanisa (lowercase, kebab-case)
- Property ID: rueil-republique
- Loan ID: loan-rueil
- Database tables may need to be created manually if schema init fails (check for -wal files)
- Run with: `npx tsx src/scripts/seed-real-estate.ts` or `bun run seed:real-estate`

---

## [Iteration 4] 2026-01-15 - US-012: API Patrimoine Immobilier

### What was implemented
- Created 3 API endpoints for real estate data:
  - `GET /api/real-estate/summary` - returns total_value, total_debt, net_equity, property_count
  - `GET /api/real-estate/properties` - returns list of properties with associated loan info
  - `GET /api/real-estate/properties/[id]` - returns full property detail with loan, owners, charges

### Files changed
- src/routes/api/real-estate/summary/+server.ts (new)
- src/routes/api/real-estate/properties/+server.ts (new)
- src/routes/api/real-estate/properties/[id]/+server.ts (new)

### Learnings for future iterations
- API endpoints use snake_case for JSON field names (matching API convention)
- Repository already provides `getRealEstateSummary()`, `getPropertiesWithLoans()`, `getPropertyWithDetails()` - no new repo methods needed
- Follow the pattern from `src/routes/api/dashboard/+server.ts` for new API endpoints
- Use `error(404, 'message')` from `@sveltejs/kit` for 404 responses

---

## [Iteration 5] 2026-01-15 - US-013: Dashboard Patrimoine Immobilier

### What was implemented
- Created `/immobilier` route with page.server.ts and page.svelte
- Created `PropertyCard.svelte` component showing property type icon, name, address, surface, rooms, DPE badge, estimated value, and loan CRD
- Displayed 3 KPIs: Valeur totale, Dette totale, Equity nette with appropriate icons and styling
- Created responsive grid layout for properties list
- PropertyCard links to `/immobilier/[id]` for detail view
- Added Immobilier link with home icon to sidebar navigation (desktop and mobile)

### Files changed
- src/routes/immobilier/+page.server.ts (new)
- src/routes/immobilier/+page.svelte (new)
- src/lib/components/real-estate/PropertyCard.svelte (new)
- src/lib/components/real-estate/index.ts (new)
- src/routes/+layout.svelte (added nav item)

### Learnings for future iterations
- Svelte 5 props syntax: `let { prop }: Props = $props()` (not generic `$props<Props>()`)
- Use existing components like DoughnutChart for reference on prop typing
- Design tokens from tokens.css: --color-gold-500 for real estate icons, --color-danger-500 for debts
- Navigation icons are inline SVGs in +layout.svelte (not imported)
- DPE color scale: A=#319834, B=#33cc31, C=#cbfc34, D=#fbfe06, E=#fbcc05, F=#f99b03, G=#f63001
- Real estate components are in src/lib/components/real-estate/ with barrel export
- Use `$derived()` for computed values from `$props()` data to avoid Svelte warnings about capturing initial values
- PropertyWithDetails type includes loan, owners[], and charges[] - use getPropertyWithDetails() from repository

---

## [Iteration 6] 2026-01-15 - US-014: Page Détail Bien

### What was implemented
- Created /immobilier/[id] route with page.server.ts and page.svelte
- Section Informations: displays property type, full address, surface, rooms, floor, DPE badge with colors, and copropriété details (name, lots, tantièmes, syndic)
- Section Valeur: shows purchase price with date, estimated value with date, and calculates gain/loss (plus-value/moins-value) with percentage
- Section Prêt: displays loan name, bank, progress bar showing repayment percentage, and full loan details (principal, rate, duration, dates, monthly payment, insurance, CRD)
- Section Propriétaires: lists owners with colored avatars, name, entity type, percentage, acquisition type and date
- Back button navigates to /immobilier dashboard
- Full responsive design for mobile devices

### Files changed
- src/routes/immobilier/[id]/+page.server.ts (new)
- src/routes/immobilier/[id]/+page.svelte (new)

### Learnings for future iterations
- Use `$derived()` for reactive computed values from page data, not plain `const`
- PropertyWithDetails extends Property with: loan: Loan | null, owners: Array<PropertyOwnership & { entity: Entity }>, charges: PropertyCharge[]
- getPropertyWithDetails(id) returns null if property not found - use error(404, ...) for proper 404 handling
- Entity colors stored in database can be used directly for avatar backgrounds
- Acquisition types: purchase, inheritance, donation, partition

---

## [Iteration 7] 2026-01-15 - US-015: Tableau d'Amortissement

### What was implemented
- Created `calculateAmortizationSchedule(loan)` function in `src/lib/utils/loan-calculator.ts`
  - Standard French amortization formula (constant payment method)
  - Returns array of {month, date, payment, principal, interest, balance}
  - Handles 0% interest rate edge case
- Created `getCurrentMonthIndex()` helper to find current month in schedule
- Created `AmortizationTable.svelte` component with:
  - Paginated table (12 rows per page)
  - Auto-navigates to page containing current month
  - Current month row is highlighted with gold background
  - Responsive pagination with ellipsis for many pages
  - Columns: Date, Mensualité, Capital, Intérêts, Restant
  - Accessible with aria-labels on navigation buttons
- Integrated amortization table into property detail page
  - Displays below the loan section when loan exists
  - Animated with staggered delay matching other sections

### Files changed
- src/lib/utils/loan-calculator.ts (new)
- src/lib/components/real-estate/AmortizationTable.svelte (new)
- src/lib/components/real-estate/index.ts (added export)
- src/routes/immobilier/[id]/+page.svelte (integrated table)

### Learnings for future iterations
- Utility functions go in `src/lib/utils/` directory
- Use `$state()` for component-local mutable state in Svelte 5
- Use `$effect()` for side effects when dependencies change (like auto-navigation)
- Amortization formula: M = P * [r(1+r)^n] / [(1+r)^n - 1]
- Round money values to 2 decimal places to avoid floating point display issues
- AmortizationEntry type exported from loan-calculator.ts for use in components

---

## [Iteration 8] 2026-01-15 - US-001: Intégration Drizzle ORM

### What was implemented
- Installed drizzle-orm and drizzle-kit dependencies
- Created comprehensive Drizzle schema in `src/infrastructure/database/schema/index.ts`:
  - All 20+ tables with type-safe columns
  - Proper indexes matching existing schema.sql
  - Relations defined between tables
- Created `src/infrastructure/database/drizzle.ts`:
  - Singleton pattern for database connection
  - Supports both Turso cloud and local SQLite
  - Exports getDb() function and schema
- Created `drizzle.config.ts` for migrations
- Migrated all repositories to use Drizzle ORM:
  - SqliteUserRepository
  - SqliteBankRepository
  - SqliteAccountRepository
  - SqliteTransactionRepository
  - RealEstateRepository (functional style preserved)
- Added npm scripts: db:generate, db:migrate, db:push, db:studio
- Updated connection.ts to re-export both turso and drizzle modules

### Files changed
- package.json (added drizzle deps and scripts)
- package-lock.json
- drizzle.config.ts (new)
- src/infrastructure/database/drizzle.ts (new)
- src/infrastructure/database/schema/index.ts (new)
- src/infrastructure/database/connection.ts (added drizzle exports)
- src/infrastructure/database/repositories/SqliteUserRepository.ts
- src/infrastructure/database/repositories/SqliteBankRepository.ts
- src/infrastructure/database/repositories/SqliteAccountRepository.ts
- src/infrastructure/database/repositories/SqliteTransactionRepository.ts
- src/infrastructure/repositories/RealEstateRepository.ts

### Learnings for future iterations
- Drizzle ORM: use `getDb()` singleton for database access
- Import schema from `@infrastructure/database/drizzle` or `schema` export
- Use `eq()`, `desc()`, `and()`, `gte()`, `lte()` from drizzle-orm for queries
- Use `sql` template for raw SQL in updates: `sql\`datetime('now')\``
- For dynamic updates with sql expressions, use `Record<string, unknown>` type
- Schema types: `schema.tableName.$inferSelect` for row type, `$inferInsert` for insert
- Raw SQL still available via turso.ts `execute()` for complex queries
- Drizzle supports SQLite/Turso natively with dialect: 'turso' in config

---

## [Iteration 9] 2026-01-15 - US-100: Domain: DataSource et CSVParser abstrait

### What was implemented
- Created domain entities for data source management and CSV parsing:
  - `DataSource.ts` - DDD entity with create/reconstitute pattern for bank data sources
  - `DataSourceType.ts` - enum for account types (CHECKING, SAVINGS, LIVRET_A, etc.)
  - `CSVParser.ts` - interface for CSV parsers with ParserKey enum (credit_mutuel, caisse_epargne, etc.)
  - `ParsedTransaction.ts` - DTO for parsed CSV transactions (date, amount, description, rawCategory, balance)
  - `DataSourceRepository.ts` - repository interface (findAll, findById, findByOwnerEntityId, save, delete)
  - `index.ts` - barrel export for all domain types

### Files changed
- src/domain/import/DataSource.ts (new)
- src/domain/import/DataSourceType.ts (new)
- src/domain/import/CSVParser.ts (new)
- src/domain/import/ParsedTransaction.ts (new)
- src/domain/import/DataSourceRepository.ts (new)
- src/domain/import/index.ts (new)

### Learnings for future iterations
- Domain import module follows existing DDD patterns: Entity base class, Result for creation validation
- DataSource links to entities table via ownerEntityId (Mathieu, Ninon, SCI IMANISA, Isaac)
- ParserKey enum maps to infrastructure parser implementations (one per bank)
- ParsedTransaction DTO includes optional fields (rawCategory, balance, valueDate, reference, additionalInfo) for bank-specific data
- Import from `@domain/import` for DataSource, CSVParser, ParsedTransaction types

---

## [Iteration 10] 2026-01-15 - US-101: Infrastructure: DataSourceRepository SQLite

### What was implemented
- Added `data_sources` table to Drizzle schema (src/infrastructure/database/schema/index.ts)
  - Columns: id, name, type, owner_entity_id, url, format, parser_key, last_sync_at, created_at
  - Indexes: owner_entity_id, parser_key
  - Foreign key to entities table with ON DELETE CASCADE
- Added `data_sources` table to schema.sql with corresponding indexes
- Created SqliteDataSourceRepository implementing DataSourceRepository interface
  - Class-based approach following DDD patterns
  - toDomain() mapper: DB row → DataSource entity using reconstitute()
  - toPersistence() mapper: DataSource entity → DB row
  - Full CRUD: findAll, findById, findByOwnerEntityId, save, delete
  - save() handles both insert and update (upsert pattern)
- Added relations: entitiesRelations now includes dataSources, dataSourcesRelations links to ownerEntity

### Files changed
- src/infrastructure/database/schema/index.ts (added dataSources table and relations)
- src/infrastructure/database/schema.sql (added data_sources table and indexes)
- src/infrastructure/repositories/SqliteDataSourceRepository.ts (new)

### Learnings for future iterations
- DDD entity repositories use class-based pattern with toDomain/toPersistence mappers
- Use Entity.reconstitute() to recreate domain entities from DB rows (validates invariants)
- UniqueId.fromString() to convert string IDs from DB to UniqueId value objects
- Save pattern: check if exists first, then update or insert accordingly
- Drizzle relations: add many() reference in parent, one() reference in child

---

## [Iteration 11] 2026-01-15 - US-102: Parser: Crédit Mutuel CSV

### What was implemented
- Created `CreditMutuelParser.ts` implementing the CSVParser interface
- Parser handles Crédit Mutuel CSV format: `Date;Date de valeur;Débit;Crédit;Libellé;Solde`
- Features:
  - Parses semicolon-separated CSV with proper quote handling
  - Parses French date format DD/MM/YYYY
  - Parses French number format (comma decimal, space thousands separator)
  - Merges Débit/Crédit columns into single signed amount (credit positive, debit negative)
  - Extracts balance and value date as optional fields
  - Skips empty lines and lines with no transactions

### Files changed
- src/infrastructure/parsers/CreditMutuelParser.ts (new)

### Learnings for future iterations
- CSV parsers go in `src/infrastructure/parsers/` directory
- Each bank has its own parser implementing the CSVParser interface from `@domain/import`
- parseCSVLine helper handles quoted fields with escaped quotes ("" → ")
- French amounts: remove spaces, replace comma with dot, then parseFloat
- Crédit Mutuel uses Latin-1 encoding (handled by browser/node when reading file)
- Debit column contains absolute values - negate when merging to signed amount

---

## [Iteration 12] 2026-01-15 - US-002: Refacto: Renommer repositories (supprimer préfixe Sqlite)

### What was implemented
- Renamed all Sqlite-prefixed repository implementations to remove the technical prefix
- Updated class names to use `Impl` suffix (convention: `UserRepositoryImpl` implements `UserRepository` interface)
- Files renamed:
  - SqliteUserRepository.ts → UserRepository.ts (class: UserRepositoryImpl)
  - SqliteBankRepository.ts → BankRepository.ts (class: BankRepositoryImpl)
  - SqliteAccountRepository.ts → AccountRepository.ts (class: AccountRepositoryImpl)
  - SqliteTransactionRepository.ts → TransactionRepository.ts (class: TransactionRepositoryImpl)
  - SqliteDataSourceRepository.ts → DataSourceRepository.ts (class: DataSourceRepositoryImpl)
- Updated container.ts imports and instantiation
- Updated database/repositories/index.ts barrel exports
- Domain interfaces (in `@domain/*/XxxRepository.ts`) kept unchanged - they define the contracts

### Files changed
- src/infrastructure/database/repositories/UserRepository.ts (renamed from SqliteUserRepository.ts)
- src/infrastructure/database/repositories/BankRepository.ts (renamed from SqliteBankRepository.ts)
- src/infrastructure/database/repositories/AccountRepository.ts (renamed from SqliteAccountRepository.ts)
- src/infrastructure/database/repositories/TransactionRepository.ts (renamed from SqliteTransactionRepository.ts)
- src/infrastructure/database/repositories/index.ts (updated exports)
- src/infrastructure/repositories/DataSourceRepository.ts (renamed from SqliteDataSourceRepository.ts)
- src/infrastructure/container/container.ts (updated imports)

### Learnings for future iterations
- DDD convention: Repository names should not expose implementation details
- Use `XxxRepositoryImpl` for implementation class, `XxxRepository` for the interface in domain layer
- Domain interfaces live in `@domain/{aggregate}/XxxRepository.ts`
- Infrastructure implementations live in `@infrastructure/database/repositories/XxxRepository.ts` or `@infrastructure/repositories/XxxRepository.ts`
- The InMemory* repositories in `@infrastructure/repositories/inmemory/` were not renamed (they correctly indicate in-memory storage for testing/demo)

---

## [Iteration 13] 2026-01-15 - US-103: Parser: Caisse d'Épargne Particulier CSV

### What was implemented
- Created `CaisseEpargneParser.ts` implementing the CSVParser interface
- Parser handles CE Particulier CSV format: 13 columns with rich data
- Format: `Date de comptabilisation;Libelle simplifie;Libelle operation;Reference;Informations complementaires;Type operation;Categorie;Sous categorie;Debit;Credit;Date operation;Date de valeur;Pointage operation`
- Features:
  - Parses semicolon-separated CSV with proper quote handling
  - Parses French date format DD/MM/YYYY (prefers Date operation over Date de comptabilisation)
  - Parses French number format (comma decimal, space thousands separator)
  - Merges Débit/Crédit columns into single signed amount
  - Extracts CE native categories (Categorie > Sous categorie) for future mapping
  - Preserves reference, type operation, and informations complementaires

### Files changed
- src/infrastructure/parsers/CaisseEpargneParser.ts (new)

### Learnings for future iterations
- CE Particulier format has 13 columns (more than CM which has 6)
- CE provides native categorization (Categorie + Sous categorie) - stored in rawCategory
- Date operation is the primary date, Date de comptabilisation is fallback
- Libelle operation is preferred over Libelle simplifie for description
- Type operation and Informations complementaires combined into additionalInfo

---

## [Iteration 14] 2026-01-15 - US-104: Parser: Caisse d'Épargne Entreprise CSV

### What was implemented
- Created `CaisseEpargneEntrepriseParser.ts` implementing the CSVParser interface
- Parser handles CE Entreprise/SCI CSV format: 10 columns
- Format: `Date comptable;Libelle simplifie;Reference;Informations complementaires;Type operation;Debit;Credit;Date operation;Date de valeur;Pointage`
- Key differences from Particulier format:
  - 10 columns instead of 13
  - No Categorie/Sous categorie columns (no native categorization)
  - No Libelle operation column (only Libelle simplifie)
  - Pointage uses Oui/Non format

### Files changed
- src/infrastructure/parsers/CaisseEpargneEntrepriseParser.ts (new)

### Learnings for future iterations
- CE Entreprise format has 10 columns (vs 13 for Particulier, 6 for CM)
- Enterprise format lacks native categorization - rawCategory is undefined
- Reuses same date/amount parsing helpers as CaisseEpargneParser

---

## [Iteration 15] 2026-01-15 - US-105: Parser: Boursorama CSV

### What was implemented
- Created `BoursoramaParser.ts` implementing the CSVParser interface
- Parser handles Boursorama CSV format: 11 columns
- Format: `dateOp;dateVal;label;category;categoryParent;supplierFound;amount;comment;accountNum;accountLabel;accountbalance`
- Features:
  - Removes UTF-8 BOM if present
  - Parses ISO date format YYYY-MM-DD
  - Parses French number format (comma decimal) with signed amounts
  - Extracts short label from "Court | Long" format
  - Builds category hierarchy from category and categoryParent (e.g., "Parent > Category")
  - Preserves comment field as additionalInfo

### Files changed
- src/infrastructure/parsers/BoursoramaParser.ts (new)

### Learnings for future iterations
- Boursorama uses ISO dates (YYYY-MM-DD) unlike other French banks (DD/MM/YYYY)
- Boursorama amounts are pre-signed (negative for debits) unlike CM which uses separate Debit/Credit columns
- Label format "Court | Long" - extract short version for description, long version is detailed
- Category structure: categoryParent > category (both optional)
- UTF-8 BOM: `\uFEFF` character at start of file, remove before parsing

---

## [Iteration 16] 2026-01-15 - US-106: Application: ImportTransactionsUseCase

### What was implemented
- Created `ParserFactory.ts` to instantiate CSV parsers based on ParserKey enum
  - Maps ParserKey to correct parser implementation (CreditMutuel, CaisseEpargne, etc.)
  - Provides isSupported() method to check if a parser key is valid
- Created `ImportTransactionsUseCase.ts` for importing CSV transactions
  - Orchestrates the full import flow: parse CSV → deduplicate → save transactions
  - Uses ParserFactory to get the correct parser based on DataSource.parserKey
  - Deduplication based on signature: date+amount+description (normalized)
  - Transforms ParsedTransaction DTO to domain Transaction entity
  - Updates DataSource.lastSyncAt after successful import
  - Returns ImportResult with counts: {imported, skipped, errors}
- Added `linkedAccountId` field to DataSource entity and schema
  - Allows linking a data source to a specific account for importing transactions
  - Updated Drizzle schema, SQL schema, domain entity, and repository

### Files changed
- src/application/import/ParserFactory.ts (new)
- src/application/import/ImportTransactionsUseCase.ts (new)
- src/application/import/index.ts (new)
- src/domain/import/DataSource.ts (added linkedAccountId)
- src/infrastructure/database/schema/index.ts (added linkedAccountId)
- src/infrastructure/database/schema.sql (added linked_account_id)
- src/infrastructure/repositories/DataSourceRepository.ts (updated for linkedAccountId)

### Learnings for future iterations
- Application layer use cases go in `src/application/{module}/` directory
- Use case pattern: constructor takes repositories, execute() takes input params
- Deduplication signature should normalize data (lowercase, trim, round amounts)
- DataSource now has linkedAccountId to know which account to import transactions into
- ImportResult includes errors array for partial success reporting
- Transaction.create takes unsigned amount, determines absolute value internally
- API endpoints: use snake_case for JSON field names (e.g., owner_entity_id, last_sync_at)

---

## [Iteration 17] 2026-01-15 - US-107: API: Endpoints Import

### What was implemented
- Created 3 API endpoints for import functionality:
  - `GET /api/data-sources` - lists all configured data sources with full details
  - `GET /api/data-sources/[id]` - returns a single data source by ID (404 if not found)
  - `POST /api/import/csv` - handles CSV file upload and import via ImportTransactionsUseCase
- POST endpoint accepts multipart/form-data with `file` (CSV file) and `dataSourceId` (string)
- Returns JSON with `{imported, skipped, errors}` from the use case

### Files changed
- src/routes/api/data-sources/+server.ts (new)
- src/routes/api/data-sources/[id]/+server.ts (new)
- src/routes/api/import/csv/+server.ts (new)

### Learnings for future iterations
- API endpoints use snake_case for JSON field names (e.g., owner_entity_id, last_sync_at)
- UniqueId.fromString() to convert string params to UniqueId for repository methods
- Use `error(404, 'message')` from @sveltejs/kit for proper HTTP 404 responses
- DataSourceRepositoryImpl imported from `@infrastructure/repositories/DataSourceRepository`
- TransactionRepositoryImpl imported from `@infrastructure/database/repositories/TransactionRepository`
- File upload: use `request.formData()` then `.get('file')` to get the File object
- File content: use `file.text()` to read CSV content as string

---

## [Iteration 18] 2026-01-15 - US-108: Seed: Configurer les 7 sources bancaires

### What was implemented
- Created Isaac entity (person, blue color) for child accounts
- Created Joint Mathieu+Ninon entity (joint, green color) for joint CE account
- Created seed script `src/scripts/seed-data-sources.ts` that inserts:
  - 2 new entities (Isaac, Joint Mathieu+Ninon)
  - 7 data sources for CSV import:
    - CM Mathieu (credit_mutuel parser)
    - CE Perso (caisse_epargne parser, Mathieu)
    - CE Joint (caisse_epargne parser, Joint)
    - CE Livret A (caisse_epargne parser, Mathieu)
    - CE SCI IMANISA (caisse_epargne_entreprise parser, SCI)
    - Boursorama Isaac CC (boursorama parser)
    - Boursorama Isaac Livret A (boursorama parser)
- Added npm script `seed:data-sources` to package.json

### Files changed
- src/scripts/seed-data-sources.ts (new)
- package.json (added seed:data-sources script)

### Learnings for future iterations
- Entity IDs follow kebab-case: isaac, joint-mathieu-ninon
- Data source IDs use ds- prefix: ds-cm-mathieu, ds-ce-perso, etc.
- Data sources table may need to be created manually if schema init fails (use sqlite3 CLI)
- Data sources link to entities via owner_entity_id FK
- Run with: `npx tsx src/scripts/seed-data-sources.ts` or `npm run seed:data-sources`

---

## [Iteration 19] 2026-01-15 - US-109: UI: Page Import avec Sync Manuel

### What was implemented
- Created `/import` route with page.server.ts and page.svelte
- Page displays data sources grouped by owner entity (Mathieu, Ninon, SCI IMANISA, Isaac, Joint)
- Each owner group shows:
  - Owner avatar with color from entities table
  - Owner name and account count
  - List of data sources with name, type, last sync date, and link to bank
- Created "Ouvrir tous les liens" button that opens all bank export URLs in new tabs
- Created `ImportDropZone.svelte` component with:
  - Drag & drop functionality for CSV files
  - Click to browse file functionality
  - Visual states: idle, importing (spinner), success, error
  - Shows import result: number imported, number skipped (duplicates), errors
- Added Import link with upload icon to navigation sidebar (both desktop and mobile)
- Info banner explains the import workflow to users

### Files changed
- src/routes/import/+page.server.ts (new)
- src/routes/import/+page.svelte (new)
- src/lib/components/import/ImportDropZone.svelte (new)
- src/lib/components/import/index.ts (new)
- src/routes/+layout.svelte (added Import nav item)

### Learnings for future iterations
- Import components go in `src/lib/components/import/` with barrel export in index.ts
- Page server loads both data sources and entities to join owner info
- GroupedDataSources interface groups sources by ownerEntityId
- ImportDropZone accepts onUpload callback and manages its own drag/drop state with $state()
- Navigation items array in +layout.svelte defines all nav links, with icon SVG conditionals below
- Import states tracked per source using a Record<sourceId, state> pattern with $state()

---


## [Iteration 20] 2026-01-15 - US-200: Domain: InvestmentPosition et InvestmentTransaction

### What was implemented
- Created comprehensive domain layer for investment tracking:
  - `InvestmentSourceType.ts` - enum (PEA, ASSURANCE_VIE, CRYPTO, CTO) with labels
  - `InvestmentSource.ts` - entity representing broker sources (name, type, owner, url, format, parserKey)
  - `InvestmentPosition.ts` - entity for portfolio positions (sourceId, symbol, isin, quantity, avgBuyPrice, currentPrice, currentValue, gainLoss, gainLossPercent)
  - `InvestmentTransaction.ts` - entity for buy/sell transactions (sourceId, date, symbol, type, quantity, pricePerUnit, totalAmount, fee)
  - `InvestmentParser.ts` - interface with parsePositions() and parseTransactions() methods
  - `ParsedPosition.ts` - DTO for parsed position data from broker files
  - `ParsedInvestmentTransaction.ts` - DTO for parsed transaction data from broker files
  - Updated `index.ts` barrel export with all new types

### Files changed
- src/domain/investment/InvestmentSourceType.ts (new)
- src/domain/investment/InvestmentSource.ts (new)
- src/domain/investment/InvestmentPosition.ts (new)
- src/domain/investment/InvestmentTransaction.ts (new)
- src/domain/investment/InvestmentParser.ts (new)
- src/domain/investment/ParsedPosition.ts (new)
- src/domain/investment/ParsedInvestmentTransaction.ts (new)
- src/domain/investment/index.ts (updated)

### Learnings for future iterations
- Investment domain follows same DDD patterns as import domain (Entity, Result, create/reconstitute)
- InvestmentParserKey enum maps to infrastructure parser implementations (bourse_direct, linxea, binance)
- InvestmentParser interface uses ArrayBuffer | string for content to support both XLSX and CSV formats
- ParsedPosition includes all fields needed for display: currentValue, gainLoss, gainLossPercent already calculated by parser
- InvestmentTransaction normalizes symbol to uppercase for consistency
- InvestmentPosition has updateFromParsed() method for easy updates from parser output
- Import from `@domain/investment` for InvestmentSource, InvestmentPosition, InvestmentTransaction types

---

## [Iteration 21] 2026-01-15 - US-201: Infrastructure: Tables et Repository Investissements

### What was implemented
- Added 3 new tables to Drizzle schema (src/infrastructure/database/schema/index.ts):
  - `investment_sources` - broker sources (Bourse Direct, Linxea, Binance)
  - `investment_positions` - portfolio positions snapshot
  - `investment_transactions` - buy/sell transaction history
- Added corresponding tables to schema.sql for manual DB creation
- Added Drizzle relations for the new tables:
  - investmentSourcesRelations: links to ownerEntity, has many positions and transactions
  - investmentPositionsRelations: links to source
  - investmentTransactionsRelations: links to source
  - Added investmentSources to entitiesRelations
- Created `InvestmentRepository.ts` with full CRUD operations:
  - Source methods: findAllSources, findSourceById, findSourcesByOwnerEntityId, saveSource, deleteSource
  - Position methods: findAllPositions, findPositionById, findPositionsBySourceId, findPositionBySourceAndSymbol, savePosition, deletePosition, deletePositionsBySourceId
  - Transaction methods: findAllTransactions, findTransactionById, findTransactionsBySourceId, findTransactionsBySymbol, saveTransaction, deleteTransaction, deleteTransactionsBySourceId
  - Aggregate queries: getInvestmentSummary, getPositionsGroupedBySource

### Files changed
- src/infrastructure/database/schema/index.ts (added 3 tables + relations)
- src/infrastructure/database/schema.sql (added 3 tables + 7 indexes)
- src/infrastructure/repositories/InvestmentRepository.ts (new)

### Learnings for future iterations
- Investment tables follow same pattern as data_sources: FK to entities via owner_entity_id
- InvestmentSourceType enum values: 'pea', 'assurance_vie', 'crypto', 'cto'
- InvestmentParserKey enum values: 'bourse_direct', 'linxea', 'binance'
- Repository follows same pattern as DataSourceRepository: toDomain/toPersistence mappers
- Aggregate queries calculate totals from positions: investedAmount = quantity * avgBuyPrice
- InvestmentRepositoryImpl is a single class handling all 3 entity types (sources, positions, transactions)

---

## [Iteration 22] 2026-01-15 - US-203: Parser: Linxea XLSX (Assurance-vie)

### What was implemented
- Created `LinxeaParser.ts` implementing the `InvestmentParser` interface
- Parser handles Linxea XLSX format with 15 columns:
  - Placement, N° Contrat, Titulaire, Produit, Catégorie, Sous-catégorie
  - Nom du support, ISIN, Nbre de parts, Dernière cotation, Date
  - Somme en Compte, Plus ou Moins Value, Prix de Revient Moyen, Perf.%
- Features:
  - Uses xlsx library to read XLSX files (same as BourseDirectParser)
  - Maps "Nom du support" to symbol, ISIN to isin
  - Maps "Nbre de parts" to quantity, "Prix de Revient Moyen" to avgBuyPrice
  - Maps "Dernière cotation" to currentPrice, "Somme en Compte" to currentValue
  - Maps "Plus ou Moins Value" to gainLoss, "Perf.%" to gainLossPercent
  - Builds category hierarchy from Catégorie > Sous-catégorie
  - Handles French number format (comma decimal, space thousands separator)
  - Skips rows with zero quantity

### Files changed
- src/infrastructure/parsers/LinxeaParser.ts (new)

### Learnings for future iterations
- Linxea format has rich metadata (Placement, N° Contrat, Titulaire, Produit) that could be useful for multi-contract tracking
- Pattern follows BourseDirectParser closely - same xlsx library, similar structure
- Assurance-vie positions don't have MIC (market identifier) like PEA positions
- parseTransactions() returns empty array - Linxea export is positions-only snapshot

---

## [Iteration 23] 2026-01-15 - US-204: Parser: Binance XLSX (Crypto)

### What was implemented
- Created `BinanceParser.ts` implementing the `InvestmentParser` interface
- Parser handles Binance buy history XLSX format with 8 columns:
  - Date(UTC+1), Method, Spend Amount, Receive Amount, Fee, Price, Status, Transaction ID
- Features:
  - Uses xlsx library to read XLSX files (same pattern as other investment parsers)
  - Filters only Status=Successful transactions
  - Extracts symbol and quantity from "Receive Amount" (e.g., "0.00132001 BTC" → symbol='BTC', quantity=0.00132001)
  - Extracts currency from "Spend Amount" (e.g., "100.00 EUR" → currency='EUR')
  - Parses price per unit, total amount, and fees
  - Preserves payment method and transaction ID for audit trail
  - Handles multiple date formats (ISO, Excel serial, DD/MM/YYYY)
- parsePositions() returns empty array - positions must be calculated from aggregated transactions

### Files changed
- src/infrastructure/parsers/BinanceParser.ts (new)

### Learnings for future iterations
- Binance export is transaction history, not positions snapshot (unlike Bourse Direct/Linxea)
- Crypto positions need to be calculated by aggregating transactions per symbol (see US-205)
- "Receive Amount" format: "{quantity} {symbol}" - regex pattern `^([\d,.]+)\s+([A-Za-z]+)$`
- "Spend Amount" format: "{amount} {currency}" - same pattern for extracting currency
- parsePositions() returns empty because Binance doesn't export positions directly

---

## [Iteration 24] 2026-01-15 - US-205: Service: Calcul positions crypto depuis transactions

### What was implemented
- Created `CalculateCryptoPositionsUseCase.ts` in `src/application/investment/`
- Aggregates buy/sell transactions by symbol to calculate:
  - Total quantity held (accounting for sells)
  - Weighted average PRU (Prix de Revient Unitaire)
- Integrates CoinGecko API for current EUR prices:
  - GET /simple/price?ids=bitcoin,ethereum&vs_currencies=eur
  - Maps 25+ popular crypto symbols to CoinGecko IDs
- Calculates for each position:
  - currentValue = quantity × currentPrice
  - gainLoss = currentValue - invested
  - gainLossPercent = (gainLoss / invested) × 100
- FIFO-like accounting for sells: reduces cost basis proportionally
- Returns InvestmentPosition[] domain entities ready for persistence
- Created barrel export in `src/application/investment/index.ts`

### Files changed
- src/application/investment/CalculateCryptoPositionsUseCase.ts (new)
- src/application/investment/index.ts (new)

### Learnings for future iterations
- Application layer use cases for investments go in `src/application/investment/`
- PRU moyen = somme(totalSpent) / somme(quantity) for each symbol
- CoinGecko API is free but rate-limited - consider caching for production
- Symbol mapping needed: BTC → bitcoin, ETH → ethereum, etc. (see SYMBOL_TO_COINGECKO_ID)
- Sell transactions reduce both quantity AND proportional cost basis
- Crypto quantities can have up to 8 decimal places (unlike fiat 2 decimals)
- CalculateCryptoPositionsUseCase can be used standalone (calculatePositions) or with domain entities (execute)

---

## [Iteration 25] 2026-01-15 - US-206: Application: ImportInvestmentsUseCase

### What was implemented
- Created `InvestmentParserFactory.ts` in `src/application/investment/`:
  - Factory pattern to instantiate the correct parser based on InvestmentParserKey
  - Supports BourseDirectParser, LinxeaParser, and BinanceParser
  - Includes `isSupported()` type guard for parser key validation
- Created `ImportInvestmentsUseCase.ts` in `src/application/investment/`:
  - Main entry point: `execute(sourceId, content)` → `ImportInvestmentsResult`
  - For PEA/AV sources: parses positions → deletes old → creates new (snapshot replacement)
  - For Crypto sources: parses transactions → deduplicates → appends → recalculates positions
  - Uses CalculateCryptoPositionsUseCase for crypto position calculation
  - Deduplication via signature: `date|symbol|type|quantity|total`
  - Updates source.lastSyncAt after successful import
- Updated barrel export in `src/application/investment/index.ts`

### Files changed
- src/application/investment/InvestmentParserFactory.ts (new)
- src/application/investment/ImportInvestmentsUseCase.ts (new)
- src/application/investment/index.ts (updated exports)

### Learnings for future iterations
- ImportInvestmentsUseCase handles different source types differently:
  - PEA/AV/CTO: Position snapshots (delete + replace)
  - Crypto: Transaction history (append + recalculate)
- Crypto transaction deduplication uses 5-part signature including rounded quantity (8 decimals) and total (2 decimals)
- InvestmentParserFactory follows same pattern as ParserFactory from import module
- Use InvestmentSourceType enum to determine import behavior
- ImportInvestmentsResult returns {positions, transactions, errors} for granular feedback

---

## [Iteration 26] 2026-01-15 - US-207: Seed: Configurer les 3 sources investissement

### What was implemented
- Enriched `src/scripts/seed-data-sources.ts` to include investment sources for XLSX imports
- Added 3 investment sources:
  - PEA Bourse Direct (pea, Mathieu, bourse_direct parser) - URL: https://www.boursedirect.fr/fr/mon-compte/portefeuilles
  - Linxea AV (assurance_vie, Mathieu, linxea parser) - URL: https://espaceclient.linxea.com/epargne/contrat/6695e318-99ab-462b-8bc2-51c083225c13
  - Binance (crypto, Mathieu, binance parser) - URL: https://www.binance.com/en/my/wallet/exchange/buysell-history
- Added INVESTMENT_SOURCE_IDS constants with `is-` prefix (matching `ds-` pattern from data sources)
- Updated `verifySeededData()` to count and list investment sources grouped by owner
- Updated `main()` to call `seedInvestmentSources()` function

### Files changed
- src/scripts/seed-data-sources.ts (enriched with investment sources)

### Learnings for future iterations
- Investment source IDs use `is-` prefix (e.g., `is-pea-bourse-direct`, `is-linxea-av`, `is-binance-crypto`)
- Investment sources go in `investment_sources` table (not `data_sources` which is for bank CSV imports)
- All 3 investment sources are owned by Mathieu entity
- Investment source types: 'pea', 'assurance_vie', 'crypto' (matching InvestmentSourceType enum)
- Investment parser keys: 'bourse_direct', 'linxea', 'binance' (matching InvestmentParserKey enum)
- Run with: `npx tsx src/scripts/seed-data-sources.ts` or `npm run seed:data-sources`

---

## [Iteration 28] 2026-01-15 - US-209: UI: Page Investissements

### What was implemented
- Created `/investissements` route with comprehensive investment portfolio view:
  - `page.server.ts` - loads grouped positions and summary from InvestmentRepository
  - `page.svelte` - full UI with KPIs, positions list, and import zones
- Displayed 3 KPIs in card layout:
  - Total investi - with position count
  - Valorisation actuelle - current portfolio value
  - Plus/Moins-value - gain/loss in € and % with dynamic coloring
- Positions grouped by investment source (PEA, AV, Crypto):
  - Source header shows icon, name, type, owner badge, last sync date, and subtotal
  - Each position displays symbol, ISIN, quantity, PRU, current value, and gain/loss
- Color coding: green for gains, red for losses (using CSS classes .positive/.negative)
- Drag & drop import zone per source for XLSX files:
  - Supports click-to-browse and drag-and-drop
  - Shows importing spinner, success message, or error
  - Link to open source URL for downloading export file
- Updated navigation from `/investments` to `/investissements`
- Full responsive design for mobile (stack layout, collapsible sections)

### Files changed
- src/routes/investissements/+page.server.ts (new)
- src/routes/investissements/+page.svelte (new)
- src/routes/+layout.svelte (updated nav link)

### Learnings for future iterations
- Investment page follows same patterns as /import page for drag & drop
- GroupedPositions type includes source info + positions array + subtotal calculations
- InvestmentPosition.investedAmount is a computed getter (quantity * avgBuyPrice)
- For XLSX imports, accept both .xlsx and .xls extensions plus .csv for flexibility
- Navigation label shortened to "Invest." to fit mobile bottom bar
- Color coding uses both CSS classes (.positive/.negative) and inline styles for flexibility

---

## [Iteration 27] 2026-01-15 - US-208: API: Endpoints Investissements

### What was implemented
- Created 4 API endpoints for investment data:
  - `POST /api/investments/import` - upload XLSX file, params: sourceId → returns {positions, transactions, errors}
  - `GET /api/investments/positions` - returns all positions grouped by source with subtotals
  - `GET /api/investments/summary` - returns {total_invested, current_value, total_gain_loss, total_gain_loss_percent}
  - `GET /api/investments/sources` - lists all investment sources with full details
- All endpoints use snake_case for JSON field names (API convention)
- Import endpoint handles ArrayBuffer content for XLSX files (not string like CSV)

### Files changed
- src/routes/api/investments/import/+server.ts (new)
- src/routes/api/investments/positions/+server.ts (new)
- src/routes/api/investments/summary/+server.ts (new)
- src/routes/api/investments/sources/+server.ts (new)

### Learnings for future iterations
- API endpoints for investments follow same pattern as /api/data-sources
- Use `file.arrayBuffer()` for XLSX files instead of `file.text()` for CSV
- InvestmentRepositoryImpl provides aggregate queries: getInvestmentSummary(), getPositionsGroupedBySource()
- Positions endpoint returns grouped data with source info + positions array + subtotal calculations
- Import endpoint reuses ImportInvestmentsUseCase from application layer

---

## [Iteration 30] 2026-01-15 - US-302: UI: Dark mode avec color-scheme

### What was implemented
- Created comprehensive theme system with light/dark mode support:
  - `src/lib/stores/theme.ts` - Svelte store for theme management
  - Supports 'light', 'dark', and 'system' modes
  - Persists user preference in localStorage ('imanisa-theme' key)
  - Listens for system preference changes (prefers-color-scheme)
  - Updates color-scheme CSS property on html element
  - Dynamically updates theme-color meta tag
- Updated CSS design tokens for dual-mode support:
  - Shared tokens (colors, typography, spacing) in :root
  - Dark mode variables in `:root, html.dark`
  - Light mode variables in `html.light`
  - APCA-compliant contrast ratios for light mode text
- Inline script in app.html prevents flash of wrong theme on page load
- Theme toggle button added to Navigation component (sidebar footer)
  - Sun icon for switching to light mode
  - Moon icon for switching to dark mode
  - Proper aria-label for accessibility
- Fixed native select styling for Windows (explicit background-color and color)
- Selection color now uses CSS variable for theme consistency

### Files changed
- src/lib/stores/theme.ts (new)
- src/app.html (added inline theme script, simplified theme-color meta)
- src/lib/styles/tokens.css (refactored for light/dark modes)
- src/lib/styles/global.css (select styling, selection color)
- src/lib/components/Navigation.svelte (added theme toggle, fixed user type)

### Learnings for future iterations
- Theme store pattern: writable store with setTheme(), toggle(), reset() methods
- Use inline script in app.html for theme initialization to prevent FOUC (Flash Of Unstyled Content)
- CSS color-scheme property enables native element styling (scrollbars, form elements)
- APCA (Advanced Perceptual Contrast Algorithm) for accessible color contrast
- Light mode needs darker semantic colors (success, danger, warning) for good contrast
- Theme toggle should show icon for the mode it will switch TO, not current mode

---

## [Iteration 31] 2026-01-15 - US-303: UI: Accessibilité et focus management

### What was implemented
- Added comprehensive accessibility features across the application:
  - Skip-to-content link in +layout.svelte for keyboard users
  - :focus-visible styles already present in global.css (verified)
  - aria-label on icon-only buttons (login page PIN pad, owner filter dots)
  - aria-pressed for toggle buttons (owner filter pills)
  - aria-live="polite" region in ImportDropZone for status announcements
  - role="alert" for error states in import component
  - aria-hidden="true" on decorative elements (icons, spinners, dots)
  - Escape key handler for modal dialogs (bank detail, account detail pages)
  - aria-labelledby on modal dialogs linking to their titles
  - role="group" with aria-label for button groups (view toggle, period pills)

### Files changed
- src/routes/+layout.svelte (added skip-to-content link with styling)
- src/routes/+page.svelte (aria-label, aria-pressed on buttons, role/aria-label on groups)
- src/lib/components/import/ImportDropZone.svelte (aria-live region, role="alert", aria-hidden)
- src/routes/banks/[bankId]/+page.svelte (Escape key handler, aria-labelledby on modal)
- src/routes/banks/[bankId]/accounts/[accountId]/+page.svelte (Escape key handler, aria-labelledby)
- src/routes/login/+page.svelte (aria-label on PIN pad icon buttons)

### Learnings for future iterations
- Skip-to-content link uses transform for show/hide animation (compositor-friendly)
- Focus the target element with tabindex="-1" for skip link to work properly
- aria-live="polite" announces changes without interrupting current speech
- aria-pressed="true/false" indicates toggle button state for screen readers
- Escape key handling via svelte:window onkeydown for modal dismissal
- aria-labelledby references the modal title's id for proper labeling
- Decorative elements (icons, dots) should have aria-hidden="true"
- role="group" with aria-label helps screen readers understand related controls

---

## [Iteration 29] 2026-01-15 - US-301: UI: Layout responsive mobile-first

### What was implemented
- Refactored layout and navigation to use mobile-first CSS pattern:
  - Base styles are now for mobile, with `@media (min-width: 769px)` for desktop
  - Extracted Navigation component to `src/lib/components/Navigation.svelte`
  - Simplified `+layout.svelte` to only contain layout structure
- Mobile optimizations:
  - Bottom navigation bar on mobile (iOS-style tab bar)
  - Sidebar navigation on desktop
  - Touch targets ≥44px on all interactive elements
  - Input font-size ≥16px to prevent iOS zoom on focus
  - `touch-action: manipulation` on all interactive elements
  - Safe area support with `env(safe-area-inset-*)` for notched devices
  - Dynamic viewport height with `100dvh` for mobile browsers
- Accessibility improvements:
  - Added `:focus-visible` styles for keyboard navigation
  - Added `aria-label` and `aria-current` attributes to navigation
  - Screen reader only utility class `.sr-only`
- Animation improvements:
  - `prefers-reduced-motion` support to disable animations
  - Explicit transition properties (never `transition: all`)
  - Compositor-friendly animations (transform/opacity only)

### Files changed
- src/routes/+layout.svelte (refactored, styles simplified)
- src/lib/components/Navigation.svelte (new)
- src/lib/styles/global.css (mobile-first, accessibility)

### Learnings for future iterations
- Mobile-first pattern: base styles for mobile, `@media (min-width: X)` for larger screens
- Use `100dvh` instead of `100vh` for true viewport height on mobile (accounts for browser chrome)
- `touch-action: manipulation` prevents double-tap zoom and improves touch response
- `-webkit-tap-highlight-color: transparent` removes blue tap highlight on mobile
- Input `font-size: max(16px, 1rem)` ensures iOS won't zoom on focus
- Use `env(safe-area-inset-*)` with `max()` function for padding that respects both design spacing and safe areas
- Navigation component uses `aria-current="page"` for screen reader accessibility
- Breakpoint 769px chosen to match iPad portrait (768px) as tablet boundary

---

## [Iteration 32] 2026-01-15 - US-304: UI: Formulaires selon guidelines

### What was implemented
- Created reusable form components in `src/lib/components/forms/`:
  - **FormInput.svelte**: Text input with autocomplete, inputmode, inline validation
    - Auto-detects autocomplete value based on field name (email, phone, password, etc.)
    - Auto-detects inputmode based on type (email → email, number → decimal, etc.)
    - Displays inline error with icon next to field
    - Supports hint text for additional context
    - Required field indicator (*)
    - Touch-friendly (44px min height, 16px font)
  - **FormSelect.svelte**: Styled select with same patterns
    - Custom dropdown arrow
    - Inline error display
    - Proper ARIA attributes
  - **Button.svelte**: Button with loading state
    - SVG spinner animation during loading
    - Maintains button text during loading
    - Supports primary, secondary, danger, ghost variants
    - Disabled state during loading
    - aria-busy attribute for screen readers
- Updated existing forms to use new components:
  - `/banks/new/+page.svelte`: Bank creation form
  - `/banks/[bankId]/+page.svelte`: Add account modal
  - `/banks/[bankId]/accounts/[accountId]/+page.svelte`: Delete and import modals
- Added focus management: focus first field on error after submit
- Added loading states with spinner to all submit buttons
- Placeholders now end with ellipsis (…) per guidelines

### Files changed
- src/lib/components/forms/FormInput.svelte (new)
- src/lib/components/forms/FormSelect.svelte (new)
- src/lib/components/forms/Button.svelte (new)
- src/lib/components/forms/index.ts (new)
- src/routes/banks/new/+page.svelte
- src/routes/banks/[bankId]/+page.svelte
- src/routes/banks/[bankId]/accounts/[accountId]/+page.svelte

### Learnings for future iterations
- Form components go in `src/lib/components/forms/` with barrel export in index.ts
- Use `$derived.by()` for computed values that need a function body in Svelte 5
- Use `AutocompleteValue` type from `HTMLInputAttributes['autocomplete']` for type-safe autocomplete
- Button loading state: disable button and show spinner with `aria-busy="true"`
- To target component children in scoped CSS, use `:global(button)` selector
- SVG spinner animation: use `<animate>` for stroke-dasharray and `<animateTransform>` for rotation
- Focus management: use `$effect()` to focus input when form error changes
- Form values: use `$state()` to capture initial form values for re-population on error

---

## [Iteration 33] 2026-01-15 - US-305: UI: Animations respectueuses

### What was implemented
- Replaced all `transition: all` usages with explicit property lists (39 occurrences across 17 files)
- Added `@media (prefers-reduced-motion: reduce)` support to components with local animations:
  - Login page: disabled spinner, shake, pulse, and scaleIn animations
  - ImportDropZone: disabled spinner animation
  - SyncStatus: disabled spinner and status-dot pulse animations
  - Investissements page: disabled spinner animation
- Made pulse animation compositor-friendly by replacing `border-color` with `opacity + transform`
- Verified all @keyframes use only compositor-friendly properties (transform, opacity)
- Confirmed transform-origin defaults are correct for all scale/rotate animations

### Files changed
- src/lib/components/PeriodFilter.svelte
- src/lib/components/SyncStatus.svelte
- src/lib/components/import/ImportDropZone.svelte
- src/lib/components/real-estate/AmortizationTable.svelte
- src/lib/components/real-estate/PropertyCard.svelte
- src/routes/+page.svelte
- src/routes/accounts/+page.svelte
- src/routes/banks/[bankId]/+page.svelte
- src/routes/banks/[bankId]/accounts/[accountId]/+page.svelte
- src/routes/banks/new/+page.svelte
- src/routes/immobilier/+page.svelte
- src/routes/import/+page.svelte
- src/routes/investissements/+page.svelte
- src/routes/investments/+page.svelte
- src/routes/loans/+page.svelte
- src/routes/login/+page.svelte
- src/routes/transactions/+page.svelte

### Learnings for future iterations
- Never use `transition: all` - always list explicit properties for performance and predictability
- Compositor-friendly animations use only `transform` and `opacity` (run on GPU without layout/paint)
- Global `prefers-reduced-motion` in global.css covers most animations, but local spinners need explicit handling
- Spinners can be stopped with `animation: none` - they're still visible but static
- The pulse animation in login used `border-color` which isn't compositor-friendly - replaced with opacity/transform

---

## [Iteration 34] 2026-01-15 - US-306: UI: Performance mobile

### What was implemented
- Added lazy loading and explicit dimensions to all images:
  - Navigation.svelte avatar: `loading="lazy" width="36" height="36"`
  - Accounts page bank logos: `loading="lazy" width="40" height="40"`
- Optimized list animations for large datasets (>50 items):
  - Added `useStaggeredAnimations` derived state in transactions, accounts, and investissements pages
  - Staggered animation-delay is now conditional: enabled for ≤50 items, disabled for >50
  - This prevents animation jank on mobile when rendering many items
- Added preconnect hint for CoinGecko API in app.html:
  - `<link rel="preconnect" href="https://api.coingecko.com">`
- Verified font-display: swap already in use via Google Fonts URL parameter

### Files changed
- src/lib/components/Navigation.svelte (added lazy loading and dimensions to avatar)
- src/routes/accounts/+page.svelte (added lazy loading, dimensions, staggered animation optimization)
- src/routes/investissements/+page.svelte (staggered animation optimization)
- src/routes/transactions/+page.svelte (staggered animation optimization)
- src/app.html (added preconnect for CoinGecko API)

### Learnings for future iterations
- Explicit image dimensions prevent CLS (Cumulative Layout Shift) on mobile
- Lazy loading images below the fold saves bandwidth on initial page load
- Staggered animations with many items (>50) cause jank on low-powered mobile devices
- Use `$derived()` for computed boolean flags to conditionally apply inline styles
- Preconnect hints help establish early connections to known API endpoints
- Google Fonts URL already includes `display=swap` which is the recommended font-display strategy

---

## [Iteration 35] 2026-01-15 - US-307: UI: Pages mobile-optimized

### What was implemented
- Enhanced /import page for mobile:
  - Larger touch targets on buttons (min-height: 52px)
  - Source links with better touch targets (min-height: 44px, padding, background)
  - Full-width buttons on mobile
- Improved ImportDropZone.svelte:
  - Larger drop zones (min-height: 88px on mobile)
  - Better spacing for touch interactions
- Mobile-optimized /immobilier/[id] property detail page:
  - Added collapsible sections with toggle functionality
  - Sections start collapsed on mobile (except Info and Value)
  - Chevron icons indicate expand/collapse state
  - Smooth animations with prefers-reduced-motion support
  - isMobile state management with resize listener
- Enhanced /investissements page:
  - Horizontal scroll for positions list on mobile
  - Sticky first column (symbol) during horizontal scroll
  - Touch-friendly scrolling (-webkit-overflow-scrolling: touch)
- Improved AmortizationTable.svelte:
  - Horizontal scroll with sticky Date column
  - Proper background handling for sticky cell states (hover, current month)
  - Hidden pagination page numbers on mobile (only prev/next + active)
- Optimized Navigation.svelte:
  - Shortened labels for mobile bottom bar: "Invest.", "Immo.", "Opéra."

### Files changed
- src/routes/import/+page.svelte (mobile button/link styles)
- src/lib/components/import/ImportDropZone.svelte (larger drop zones)
- src/routes/immobilier/[id]/+page.svelte (collapsible sections)
- src/routes/investissements/+page.svelte (horizontal scroll, sticky column)
- src/lib/components/real-estate/AmortizationTable.svelte (sticky Date column)
- src/lib/components/Navigation.svelte (shortened labels)

### Learnings for future iterations
- Collapsible sections on mobile: use $state for expandedSections record and isMobile boolean
- Check window.innerWidth in $effect with cleanup for resize listener
- Sticky columns in horizontal scroll: position: sticky, left: 0, z-index for proper layering
- Background inheritance issues with sticky cells: explicitly set background for all states (normal, hover, highlight)
- Hidden pagination on mobile: show only prev/next arrows + active page number
- Navigation labels: abbreviate for mobile to fit bottom bar ("Investissements" → "Invest.")

---

## [Iteration 36] 2026-01-15 - US-400: Domain - Category et CategoryRule

### What was implemented
- Created comprehensive budget domain layer for transaction categorization:
  - `Category.ts` - Entity with hierarchical structure (parentId for parent/child relationships)
    - Properties: name, parentId, icon, color, createdAt
    - Methods: create(), reconstitute(), update(), isRoot getter
    - Validation: name required, valid hex color, icon required
  - `CategoryRule.ts` - Entity for regex-based auto-categorization
    - Properties: categoryId, pattern (regex), priority, source filter, isActive, createdAt
    - Methods: create(), reconstitute(), matches(description), update(), activate(), deactivate()
    - Validates regex pattern on creation
  - `TransactionCategoryAssignment.ts` - Value object linking transactions to categories
    - CategorySource enum: BANK, AUTO, MANUAL with French labels
    - Confidence scores: 1.0 for bank/manual, 0.8 for auto
    - canOverwrite() helper to protect manual assignments
  - `CategoryRepository.ts` - Interface with full CRUD operations
    - Category methods: findAll, findById, findRoot, findChildren, save, delete
    - Rule methods: findAll, findActive by priority, findById, findByCategory, save, delete
    - Assignment methods: find by transaction, find by category, save, delete
    - Aggregate queries: findUnassigned, countByCategory with date range

### Files changed
- src/domain/budget/Category.ts (new)
- src/domain/budget/CategoryRule.ts (new)
- src/domain/budget/TransactionCategoryAssignment.ts (new)
- src/domain/budget/CategoryRepository.ts (new)
- src/domain/budget/index.ts (new)

### Learnings for future iterations
- Budget domain follows same DDD patterns as import/investment domains: Entity base class, Result for validation
- TransactionCategoryAssignment is a value object (interface), not entity - no identity needed for liaison
- CategorySource enum determines protection: MANUAL > BANK > AUTO (manual can't be auto-overwritten)
- Confidence score concept allows future ML integration while maintaining rule-based default
- Import from `@domain/budget` for Category, CategoryRule, TransactionCategoryAssignment, CategorySource

---

## [Iteration 37] 2026-01-15 - US-401: Infrastructure - Tables et Repository Catégories

### What was implemented
- Added budget module tables to Drizzle schema:
  - `categories` - hierarchical categories (id, name, parent_id with self-reference, icon, color)
  - `category_rules` - regex rules for auto-categorization (category_id, pattern, priority, source_filter, is_active)
  - `transaction_categories` - linking table (transaction_id as PK, category_id, source enum, confidence)
- Added proper indexes for performance:
  - categories: idx_categories_parent_id, idx_categories_name
  - category_rules: idx_category_rules_category_id, idx_category_rules_priority, idx_category_rules_is_active
  - transaction_categories: idx_transaction_categories_category_id, idx_transaction_categories_source
- Added Drizzle relations:
  - categoriesRelations (parent/child self-relation, rules, transactionAssignments)
  - categoryRulesRelations (category)
  - transactionCategoriesRelations (transaction, category)
  - Updated transactionsRelations to include categoryAssignment
- Created CategoryRepositoryImpl with full CRUD:
  - Category: findAll, findById, findRoot, findChildren, save, delete
  - CategoryRule: findAll, findActive by priority, findById, findByCategory, save, delete
  - Assignment: findByTransaction, findByCategory, save, delete
  - Aggregate: findUnassignedTransactionIds, countTransactionsByCategory(dateRange)

### Files changed
- src/infrastructure/database/schema/index.ts (added tables and relations)
- src/infrastructure/repositories/CategoryRepository.ts (new)

### Learnings for future iterations
- Self-referencing foreign key in SQLite: use function returning column type to avoid circular reference
- SQLite doesn't support proper FULL OUTER JOIN, use LEFT JOIN + WHERE IS NULL for "not in" queries
- Raw SQL queries use execute() from turso.ts, not db.execute() from Drizzle
- For aggregate queries with date ranges, use simple string comparison for SQLite date columns
- Transaction-to-category is 1:1 (transactionId is primary key in transaction_categories)

---

## [Iteration 38] 2026-01-15 - US-402: Seed - Catégories de base hiérarchiques

### What was implemented
- Created comprehensive seed-categories.ts script:
  - 10 root (parent) categories: Logement, Alimentation, Transport, Loisirs, Sante, Revenus, Epargne, Impots, Banque, Autre
  - 62 sub-categories organized by parent (e.g., Loyer, Charges, Restaurant, Courses, Carburant, etc.)
  - Each category has: stable ID (cat-*), name, icon, color
  - Sub-categories inherit parent's color
- Bank category mappings stored as category_rules:
  - ~20 Caisse d'Epargne mappings (source_filter: caisse_epargne)
  - ~25 Boursorama mappings (source_filter: boursorama)
  - Mappings use exact match regex pattern with escapeRegex() helper
  - All rules have priority 100 (bank-provided categories)
- Script includes verification function showing category hierarchy

### Files changed
- src/scripts/seed-categories.ts (new)

### Learnings for future iterations
- Bank category mappings: store as category_rules with source_filter and exact match pattern
- Use escapeRegex() helper to escape special regex chars in bank category names
- Stable category IDs (cat-logement, cat-courses) allow easy referencing in code
- Sub-categories inherit parent color for visual consistency in UI
- `INSERT OR REPLACE` allows re-running seed script safely
- Cast execute() result rows with `as unknown as Type` for TypeScript

---

## [Iteration 39] 2026-01-15 - US-403: Seed - Règles de catégorisation regex

### What was implemented
- Added 32 regex categorization rules to seed-categories.ts for auto-categorization
- Rules organized by priority (10-389) to resolve conflicts deterministically:
  - Lower priority number = higher precedence (checked first)
  - Categories use 10-point ranges (e.g., 10-19 for courses, 20-29 for restaurants)
- Categories covered:
  - **Alimentation** (p10-59): Courses (supermarkets), Restaurant, Fast-food, Bar/Café, Livraison
  - **Transport** (p60-139): Carburant, Péage, Parking, Transports en commun, Taxi/VTC, Avion, Entretien auto, Location voiture
  - **Logement** (p140-189): Charges (utilities), Internet/TV, Assurance habitation, Travaux, Ameublement
  - **Loisirs** (p190-249): Abonnements (streaming), Sport, Culture, Jeux, Shopping, High-tech
  - **Santé** (p250-299): Pharmacie, Médecin, Dentiste, Opticien, Mutuelle
  - **Banque** (p300-329): Frais bancaires, Retrait DAB, Intérêts
  - **Revenus** (p330-359): Salaire, Remboursement, Aides/Allocations
  - **Impôts** (p360-369): DGFIP, taxes
  - **Assurance auto** (p370-379)
  - **Épargne** (p380-389): Livret A, LDDS, PEL
- Created `seedRegexRules()` function that inserts rules with source_filter=null (applies to all banks)
- Updated `verifySeededData()` to show bank rules vs regex rules counts separately
- Special regex patterns:
  - Negative lookahead `uber(?!\\s*eats)` to distinguish Uber rides from Uber Eats
  - Pattern `amazon(?!\\s*prime)` to categorize Amazon shopping vs Amazon Prime subscription

### Files changed
- src/scripts/seed-categories.ts (added ~300 lines for regex rules and seedRegexRules function)

### Learnings for future iterations
- Regex rules use source_filter=null to apply across all banks (unlike bank mappings which use source_filter='caisse_epargne' or 'boursorama')
- Priority system: bank category mappings have priority 100, regex rules use 10-389 range
- Use negative lookahead `(?!pattern)` to exclude specific matches (e.g., Uber vs Uber Eats)
- Rule ID pattern: `rule-regex-{n}` for regex rules (vs `rule-ce-{n}` and `rule-bourso-{n}` for bank mappings)
- Regex patterns are case-insensitive by default when used in AutoCategorizationService
- Total rules after seed: ~65 bank mappings + 32 regex rules = ~97 rules

---

## [Iteration 40] 2026-01-15 - US-404: Service: Mapping catégories bancaires

### What was implemented
- Created BankCategoryMapper service in `src/application/budget/BankCategoryMapper.ts`
- Maps Caisse d'Épargne bank categories to internal category IDs:
  - Handles formats like "Categorie" and "Categorie > Sous categorie"
  - ~20+ CE category mappings including accented variants
- Maps Boursorama bank categories to internal category IDs:
  - Handles formats like "category" and "categoryParent > category"
  - ~25+ Boursorama category mappings
- Matching strategy (in order of priority):
  1. Exact match on full category string
  2. Match on child part (most specific) from "Parent > Child"
  3. Match on parent part as fallback
  4. Returns null if no match found
- Case-insensitive matching for robustness
- Helper functions:
  - `mapBankCategory(rawCategory, parserKey)` - main mapping function
  - `parserProvidesCategories(parserKey)` - checks if bank provides native categories
  - `getSupportedBankParsers()` - returns list of parsers with category support
- Created barrel export in `src/application/budget/index.ts`

### Files changed
- src/application/budget/BankCategoryMapper.ts (new)
- src/application/budget/index.ts (new)

### Learnings for future iterations
- Application layer services for budget go in `src/application/budget/`
- Bank category mapping uses ParserKey enum from `@domain/import/CSVParser`
- CE parser produces rawCategory as "Categorie > Sous categorie" format
- Boursorama parser produces rawCategory as "categoryParent > category" format
- Credit Mutuel has no native categories - returns null (will use regex rules)
- Case-insensitive matching helps with accent variations (Santé vs Sante, Électricité vs Electricite)
- Import from `@application/budget` for mapBankCategory, CategoryMappingResult

---

## [Iteration 41] 2026-01-15 - US-406: Hook Auto-catégorisation à l'import

### What was implemented
- Integrated AutoCategorizationService into ImportTransactionsUseCase
- Modified execute() method to:
  - Store parsed transaction data (including rawCategory) alongside domain transaction
  - Call categorizeTransactions() after saving transactions to database
  - Return categorization stats in ImportResult
- Created new CategorizationStats interface with byBank, byRule, uncategorized counts
- Updated /api/import/csv endpoint to:
  - Inject CategoryRepository into ImportTransactionsUseCase
  - Return categorization stats in JSON response (snake_case: by_bank, by_rule, uncategorized)
- Categorization flow at import:
  1. Parse CSV and create transactions
  2. Save transactions to database
  3. For each transaction, call AutoCategorizationService.categorizeAndSave()
  4. Count results by source (BANK vs AUTO) and uncategorized
  5. Return stats in import result

### Files changed
- src/application/import/ImportTransactionsUseCase.ts (major changes)
- src/application/import/index.ts (added CategorizationStats export)
- src/routes/api/import/csv/+server.ts (added CategoryRepository, categorization response)

### Learnings for future iterations
- ImportTransactionsUseCase now accepts optional CategoryRepository (3rd constructor param)
- Categorization happens automatically when CategoryRepository is provided
- API response includes categorization object with snake_case fields
- rawCategory from ParsedTransaction is preserved through import for bank category mapping
- TransactionForCategorization interface requires: id, description, rawCategory?, parserKey?
- CategorySource.BANK for bank categories, CategorySource.AUTO for regex rules

---

## [Iteration 42] 2026-01-15 - US-407: API Endpoints Catégories et Budget

### What was implemented
- Created 5 API endpoints for category and budget management:
  - `GET /api/categories` - returns all categories structured hierarchically (parent → children)
  - `GET /api/transactions/[id]/category` - returns category assignment for a transaction
  - `PUT /api/transactions/[id]/category` - manually assigns a category (source='manual', confidence=1.0)
  - `POST /api/budget/recategorize` - re-runs auto-categorization on all uncategorized transactions
  - `GET /api/budget/summary` - returns expenses/income by category for a period
    - Supports period params: month, last_month, quarter, year
    - Supports custom date range with start_date/end_date params
    - Returns totals, expenses by category, income by category, uncategorized counts

### Files changed
- src/routes/api/categories/+server.ts (new)
- src/routes/api/transactions/[id]/category/+server.ts (new)
- src/routes/api/budget/recategorize/+server.ts (new)
- src/routes/api/budget/summary/+server.ts (new)

### Learnings for future iterations
- Budget endpoints go in `src/routes/api/budget/` directory
- Transaction sub-endpoints use nested route: `src/routes/api/transactions/[id]/category/`
- Period calculation helper function getDateRange() returns start, end, and label
- Hierarchical category structure: build a Map first, then link children to parents in second pass
- Use `execute()` from turso.ts for aggregate queries with JOINs (simpler than Drizzle for complex SQL)
- French locale for date formatting: `toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })`
- Always return snake_case for JSON API responses (e.g., parent_id, start_date, total_amount)

---

## [Iteration 43] 2026-01-15 - US-900: Setup Testing (Vitest + In-Memory SQLite)

### What was implemented
- Installed testing dependencies: vitest, @testing-library/svelte, jsdom, @vitest/coverage-v8
- Created vitest.config.ts with:
  - Path aliases matching svelte.config.js (@domain, @application, @infrastructure, @lib, $lib)
  - jsdom environment for component testing
  - Coverage configuration with v8 provider
  - Sequential test execution to avoid DB conflicts
- Created src/tests/setup.ts for global test initialization (mock env, cleanup)
- Created src/tests/fixtures/ directory structure for CSV/XLSX test fixtures
- Created src/tests/utils/createTestDb.ts with:
  - In-memory SQLite database creation via @libsql/client
  - Schema initialization from schema.sql (with comment removal and table/index separation)
  - testFixtures factory for generating test entities, users, banks, accounts, transactions, etc.
- Added test scripts to package.json: test, test:watch, test:coverage, test:ui
- Added budget module tables to schema.sql (categories, category_rules, transaction_categories)
- Verified all tests pass with setup verification test file

### Files changed
- package.json (added test scripts and dependencies)
- package-lock.json
- vitest.config.ts (new)
- src/tests/setup.ts (new)
- src/tests/setup.test.ts (new - verification tests)
- src/tests/utils/createTestDb.ts (new)
- src/tests/utils/index.ts (new)
- src/tests/fixtures/index.ts (new)
- src/infrastructure/database/schema.sql (added budget tables)

### Learnings for future iterations
- **In-memory SQLite**: Use `:memory:` URL with @libsql/client for isolated test databases
- **Schema parsing**: Remove comment lines before splitting by `;`, then separate CREATE TABLE from CREATE INDEX
- **testFixtures pattern**: Factory functions with unique IDs using `Date.now()` + random suffix
- **Vitest 4**: Don't use poolOptions (deprecated), use sequence.concurrent instead
- **Coverage**: Use @vitest/coverage-v8 for V8-based coverage
- **Test isolation**: Each test file should create its own testDb and cleanup in afterAll
- Run tests with: `npm run test` (single run) or `npm run test:watch` (watch mode)

---

## [Iteration 44] 2026-01-15 - US-408: UI Page Budget avec répartition par catégorie

### What was implemented
- Created `/budget` route with comprehensive budget visualization:
  - `page.server.ts` - loads budget summary data grouped by parent categories
  - `page.svelte` - full UI with KPIs, chart, and category breakdown
- Period selector with 4 options:
  - Current month (default), previous month, quarter, year
  - URL-based navigation for bookmarkable period selection
- KPI cards showing:
  - Total expenses (red), total income (green), net balance (green/red)
  - Dynamic coloring based on positive/negative values
- DoughnutChart integration:
  - Uses existing Chart.js component
  - Shows top 8 categories by amount
  - Toggle between expenses and income view
- Category breakdown list:
  - Categories grouped by parent with expandable drill-down
  - Progress bar showing percentage of total
  - Amount and percentage for each category
  - Child categories shown when expanded
- Uncategorized section:
  - Shows count and total of uncategorized transactions
  - Link to /transactions?uncategorized=true for review
- Mobile-responsive design:
  - Stacked layout on mobile
  - Full-width period buttons
  - Collapsible categories
- Added Budget link with pie-chart icon to navigation sidebar

### Files changed
- src/routes/budget/+page.server.ts (new)
- src/routes/budget/+page.svelte (new)
- src/lib/components/Navigation.svelte (added Budget nav item with pie-chart icon)
- prd.json (marked US-408 as passes: true)

### Learnings for future iterations
- Budget page uses `goto()` with `replaceState: true` for period changes (no history stack)
- Parent category aggregation: loop through child categories, accumulate totals to parent
- `$derived.by()` for computed values needing function body (chartData with slice/map)
- Chart data limited to top 8 categories to keep legend readable
- Expandable state managed with `Set<string>` for category IDs
- View toggle between expenses/income using simple `$state<'expenses' | 'income'>()`
- Category bar uses inline style with percentage width and category color

---

## [Iteration 45] 2026-01-15 - US-409: UI Catégorisation manuelle inline

### What was implemented
- Created `CategoryBadge.svelte` component for inline category editing:
  - Displays category name with icon and color
  - Source indicator dot: blue (bank), gray (auto), green (manual)
  - Question mark badge for uncategorized transactions (warning style)
  - Dropdown with hierarchical category selection (parent > child)
  - Mobile-responsive: bottom sheet dropdown on mobile
  - Loading spinner during API call
  - Click outside or Escape key to close dropdown
- Updated `/transactions` page with inline categorization:
  - CategoryBadge replaces static category text in transaction rows
  - Added "Non catégorisées" filter button with count badge
  - URL-based filter: `?uncategorized=true` for bookmarkable view
  - aria-live region for screen reader announcements on category change
- Updated `page.server.ts` to load categories and assignments:
  - Query all categories with hierarchical structure
  - Query transaction_categories for assignments with source info
  - Load uncategorized count for filter badge
  - Support `?uncategorized=true` filter parameter

### Files changed
- src/lib/components/CategoryBadge.svelte (new)
- src/routes/transactions/+page.server.ts (enhanced with categories)
- src/routes/transactions/+page.svelte (CategoryBadge integration, filter)

### Learnings for future iterations
- CategoryBadge component uses `$state()` for isOpen, isLoading, dropdownRef
- Click outside detection: document.addEventListener in $effect with cleanup
- Screen reader announcements: aria-live="polite" region with $state message
- invalidateAll() from $app/navigation refreshes page data after mutation
- Mobile dropdown: use position: fixed with left/right/bottom instead of absolute
- Category source colors: bank=primary, auto=muted, manual=success
- Uncategorized filter: LEFT JOIN with WHERE NULL to find missing assignments

---

## [Iteration X] 2026-01-15 - US-411: Feature suggestion de règle depuis transaction

### What was implemented
- Created `CategorySuggestion.svelte` component for post-categorization popup
- Popup appears after manual category assignment on transactions page
- Pre-fills pattern from transaction description (simplified/cleaned):
  - Removes date prefixes/suffixes
  - Removes transaction type prefixes (VIR, PRLV, CB, etc.)
  - Extracts merchant name from long descriptions
  - Escapes special regex characters
- Creates rule via POST /api/budget/rules with priority 50
- Auto-triggers recategorization after rule creation
- "Ne plus demander" option persisted in localStorage (key: imanisa-category-suggestion-disabled)
- Accessible with ARIA labels, keyboard support (Escape to close)
- Success animation shows briefly before auto-closing

### Files changed
- src/lib/components/CategorySuggestion.svelte (new)
- src/routes/transactions/+page.svelte (integrated CategorySuggestion)

### Learnings for future iterations
- Pattern extraction: escapeRegex() for special chars, split on separators for merchant name
- localStorage check: wrap in `typeof localStorage === 'undefined'` for SSR safety
- Popup state: separate showSuggestion and suggestionData states for clean reset
- Auto-close: setTimeout after success animation completes
- Category lookup: need to traverse hierarchy to find child categories
- svelte-check error: explicit type annotation needed in find() callback `(tx: Transaction) =>`

---

---

## [Iteration 46] 2026-01-15 - US-901: Tests Domain Layer (unitaires)

### What was implemented
- Created comprehensive unit tests for all domain layer entities and value objects
- 23 test files covering:
  - Shared utilities: Result.test.ts, UniqueId.test.ts, Entity.test.ts, ValueObject.test.ts
  - Account domain: Money.test.ts, Account.test.ts, AccountType.test.ts, AssetCategory.test.ts
  - Bank domain: Bank.test.ts, BankTemplate.test.ts
  - Transaction domain: Transaction.test.ts, TransactionType.test.ts, TransactionCategory.test.ts
  - User domain: User.test.ts, Email.test.ts
  - Import domain: DataSource.test.ts, DataSourceType.test.ts, CSVParser.test.ts (ParserKey tests)
  - Investment domain: InvestmentPosition.test.ts, InvestmentTransaction.test.ts
  - Budget domain: Category.test.ts, CategoryRule.test.ts, TransactionCategoryAssignment.test.ts
- Total: 359 tests passing
- Coverage: nominal cases, edge cases, validation errors, reconstitution from persistence

### Files changed
- src/domain/shared/Result.test.ts (new)
- src/domain/shared/UniqueId.test.ts (new)
- src/domain/shared/Entity.test.ts (new)
- src/domain/shared/ValueObject.test.ts (new)
- src/domain/account/Money.test.ts (new)
- src/domain/account/Account.test.ts (new)
- src/domain/account/AccountType.test.ts (new)
- src/domain/account/AssetCategory.test.ts (new)
- src/domain/bank/Bank.test.ts (new)
- src/domain/bank/BankTemplate.test.ts (new)
- src/domain/transaction/Transaction.test.ts (new)
- src/domain/transaction/TransactionType.test.ts (new)
- src/domain/transaction/TransactionCategory.test.ts (new)
- src/domain/user/User.test.ts (new)
- src/domain/user/Email.test.ts (new)
- src/domain/import/DataSource.test.ts (new)
- src/domain/import/DataSourceType.test.ts (new)
- src/domain/import/CSVParser.test.ts (new)
- src/domain/investment/InvestmentPosition.test.ts (new)
- src/domain/investment/InvestmentTransaction.test.ts (new)
- src/domain/budget/Category.test.ts (new)
- src/domain/budget/CategoryRule.test.ts (new)
- src/domain/budget/TransactionCategoryAssignment.test.ts (new)

### Learnings for future iterations
- Domain tests focus on business logic validation, not infrastructure concerns
- Use toMatchInlineSnapshot for complex object comparison in tests
- Entity.create() returns Result<Entity, Error> - test both success and failure paths
- Value objects use equals() method for comparison testing
- Entity equality is based on UniqueId, not props comparison
- reconstitute() method skips validation - useful for loading from persistence

---

## [Iteration 47] 2026-01-15 - US-902: Tests Parsers (unitaires avec fixtures)

### What was implemented
- Created CSV fixtures for 4 banks (realistic test data):
  - credit_mutuel.csv: 6 transactions with debit/credit, French format
  - boursorama.csv: 5 transactions with ISO dates, category hierarchy
  - caisse_epargne.csv: 5 transactions with 13 columns, native categories
  - caisse_epargne_entreprise.csv: 5 transactions with 10 columns, Oui/Non pointage
- Created XLSX fixture generators (programmatic):
  - Bourse Direct: PEA positions with PRU, +/- value, market info
  - Linxea: Life insurance positions with category hierarchy
  - Binance: Crypto buy transactions with amount/symbol extraction
- Created 7 parser test files with 91 tests total:
  - CreditMutuelParser.test.ts: 13 tests
  - BoursoramaParser.test.ts: 15 tests
  - CaisseEpargneParser.test.ts: 17 tests
  - CaisseEpargneEntrepriseParser.test.ts: 17 tests
  - BourseDirectParser.test.ts: 8 tests
  - LinxeaParser.test.ts: 9 tests
  - BinanceParser.test.ts: 12 tests

### Files changed
- src/tests/fixtures/csv/credit_mutuel.csv (new)
- src/tests/fixtures/csv/boursorama.csv (new)
- src/tests/fixtures/csv/caisse_epargne.csv (new)
- src/tests/fixtures/csv/caisse_epargne_entreprise.csv (new)
- src/tests/fixtures/xlsx/index.ts (new)
- src/infrastructure/parsers/CreditMutuelParser.test.ts (new)
- src/infrastructure/parsers/BoursoramaParser.test.ts (new)
- src/infrastructure/parsers/CaisseEpargneParser.test.ts (new)
- src/infrastructure/parsers/CaisseEpargneEntrepriseParser.test.ts (new)
- src/infrastructure/parsers/BourseDirectParser.test.ts (new)
- src/infrastructure/parsers/LinxeaParser.test.ts (new)
- src/infrastructure/parsers/BinanceParser.test.ts (new)

### Learnings for future iterations
- CSV fixtures need exact column count matching parser expectations
- XLSX fixtures can be generated programmatically using xlsx library utilities
- Test both fixture file parsing and inline data parsing
- Include edge cases: empty files, missing fields, zero quantities (should skip)
- InvestmentParsers implement both parsePositions() and parseTransactions() with one returning []
