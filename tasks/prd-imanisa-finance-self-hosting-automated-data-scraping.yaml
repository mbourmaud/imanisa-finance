title: "imanisa-finance - Self-Hosting & Automated Data Scraping"
version: "1.0"
lastUpdated: "2026-01-14"

overview:
  problemStatement: |
    L'application imanisa-finance nécessite actuellement une mise à jour manuelle
    des données financières chaque mois via import CSV. Cette tâche répétitive
    est chronophage et source d'erreurs.
  solution: |
    Implémenter un système de scraping automatisé via Docker pour récupérer
    les données des différentes plateformes financières, avec notifications
    Telegram pour le suivi.
  users:
    - type: "primary"
      description: "Toi et ta femme"
      usage: "Consultation du patrimoine familial (comptes bancaires, investissements, prêts immobiliers)"

goals:
  - id: "G1"
    title: "Automatisation"
    description: "Réduire le temps de mise à jour manuelle de ~30min/mois à ~0"
  - id: "G2"
    title: "Fiabilité"
    description: "Système de retry et notifications pour garantir la fraîcheur des données"
  - id: "G3"
    title: "Flexibilité"
    description: "Déploiement Docker agnostique (VPS, Raspberry Pi, PC local)"

successMetrics:
  - metric: "Temps de mise à jour manuelle"
    target: "< 5 min/mois (intervention 2FA uniquement)"
  - metric: "Taux de succès des scrapes"
    target: "> 90%"
  - metric: "Freshness des données"
    target: "< 7 jours de retard max"

scope:
  mvp:
    phase: "Phase 1 - Binance uniquement"
    items:
      - id: "MVP-1"
        description: "Configuration Docker pour déploiement agnostique"
        status: "done"
      - id: "MVP-2"
        description: "Scraper Binance (via API officielle)"
        status: "done"
      - id: "MVP-3"
        description: "Déclenchement manuel via UI"
        status: "done"
      - id: "MVP-4"
        description: "Cron job automatique configurable"
        status: "done"
      - id: "MVP-5"
        description: "Notifications Telegram (succès/échec)"
        status: "done"
      - id: "MVP-6"
        description: "Dashboard affichant la date de dernière mise à jour par source"
        status: "done"
      - id: "MVP-7"
        description: "Système de retry (3 tentatives max)"
        status: "done"
      - id: "MVP-8"
        description: "Setup Telegram Bot (guide inclus)"
        status: "done"

  phase2:
    phase: "Phase 2 - Caisse d'Épargne"
    items:
      - id: "P2-1"
        description: "Scraper Caisse d'Épargne Perso (Playwright)"
        status: "pending"
      - id: "P2-2"
        description: "Scraper Caisse d'Épargne SCI (login séparé)"
        status: "pending"
      - id: "P2-3"
        description: "Gestion auth mixte (parfois validation mobile requise)"
        status: "pending"
      - id: "P2-4"
        description: "Notification 'Validation manuelle requise' + retry auto"
        status: "pending"

  phase3:
    phase: "Phase 3 - Post-MVP"
    items:
      - id: "P3-1"
        description: "Scraper Bourse Direct (PEA)"
        status: "pending"
      - id: "P3-2"
        description: "Scraper Linxea (Assurance Vie)"
        status: "pending"
      - id: "P3-3"
        description: "Scraper CIC"
        status: "pending"
      - id: "P3-4"
        description: "Scraper Crédit Mutuel"
        status: "pending"

  outOfScope:
    - "Application mobile native"
    - "Multi-tenancy / autres utilisateurs"
    - "Synchronisation temps réel"
    - "Hébergement Freebox Pop (non supporté)"

technicalArchitecture:
  deployment: "Docker Agnostique (VPS / RPi / PC)"
  techStack:
    - component: "App"
      technology: "SvelteKit (existant)"
    - component: "Scraper MVP"
      technology: "Node.js + Binance API"
    - component: "Scraper Phase 2"
      technology: "Node.js + Playwright"
    - component: "Database"
      technology: "SQLite (existant)"
    - component: "Container"
      technology: "Docker + docker-compose"
    - component: "Scheduler"
      technology: "node-cron"
    - component: "Notifications"
      technology: "Telegram Bot API"
    - component: "Credentials"
      technology: "Variables d'environnement (fichier .env)"

requirements:
  binance:
    phase: "MVP"
    items:
      - id: "BIN-1"
        requirement: "Authentification via API Key + Secret"
        priority: "P0"
      - id: "BIN-2"
        requirement: "Récupération balances Spot"
        priority: "P0"
      - id: "BIN-3"
        requirement: "Récupération balances Earn/Staking"
        priority: "P1"
      - id: "BIN-4"
        requirement: "Conversion en EUR (via prix spot)"
        priority: "P0"
      - id: "BIN-5"
        requirement: "Export format compatible CSV existant"
        priority: "P0"

  caisseEpargne:
    phase: "Phase 2"
    items:
      - id: "CE-1"
        requirement: "Login automatique (identifiant + mot de passe)"
        priority: "P0"
      - id: "CE-2"
        requirement: "Gestion clavier virtuel (si présent)"
        priority: "P0"
      - id: "CE-3"
        requirement: "Gestion auth mixte : détection validation mobile requise"
        priority: "P0"
      - id: "CE-4"
        requirement: "Notification Telegram 'Validation manuelle requise pour CE'"
        priority: "P0"
      - id: "CE-5"
        requirement: "Retry automatique après 2-3 min post-validation"
        priority: "P0"
      - id: "CE-6"
        requirement: "2 comptes séparés : CE Perso + CE SCI (logins différents)"
        priority: "P0"

  notificationsAndRetry:
    items:
      - id: "NOT-1"
        requirement: "Bot Telegram dédié pour notifications"
        priority: "P0"
      - id: "NOT-2"
        requirement: "Notification succès avec récap des montants"
        priority: "P0"
      - id: "NOT-3"
        requirement: "Notification échec après 3 tentatives"
        priority: "P0"
      - id: "RET-1"
        requirement: "3 tentatives max, délai : 5min, 15min, 30min"
        priority: "P0"

userStories:
  mvp:
    - id: "US-1"
      story: |
        En tant qu'utilisateur, je veux que mes données Binance soient récupérées
        automatiquement chaque semaine afin de ne pas avoir à exporter manuellement
      acceptanceCriteria:
        - "Cron job configurable"
        - "Données importées dans la DB"
        - "Notification Telegram de succès"
    - id: "US-2"
      story: |
        En tant qu'utilisateur, je veux pouvoir déclencher manuellement une
        synchronisation Binance depuis l'UI afin de forcer une mise à jour quand j'en ai besoin
      acceptanceCriteria:
        - "Bouton 'Sync' dans l'interface"
        - "Feedback visuel pendant le sync"
        - "Notification du résultat"
    - id: "US-3"
      story: |
        En tant qu'utilisateur, je veux voir la date de dernière mise à jour de
        chaque source afin de savoir si mes données sont à jour
      acceptanceCriteria:
        - "Indicateur 'Last sync: X days ago' par source"
        - "Alerte visuelle si > 7 jours"
    - id: "US-4"
      story: |
        En tant qu'utilisateur, je veux être notifié sur Telegram en cas d'échec
        de synchronisation afin de pouvoir intervenir si nécessaire
      acceptanceCriteria:
        - "Notification après 3 échecs"
        - "Message avec détail de l'erreur"

  phase2:
    - id: "US-5"
      story: |
        En tant qu'utilisateur, je veux que mes comptes CE Perso et CE SCI soient
        synchronisés automatiquement afin d'avoir une vue consolidée de mon patrimoine
      acceptanceCriteria:
        - "2 logins séparés configurables"
        - "Sync indépendant pour chaque compte"
    - id: "US-6"
      story: |
        En tant qu'utilisateur, je veux être notifié quand une validation mobile
        est requise afin de pouvoir débloquer le scraper rapidement
      acceptanceCriteria:
        - "Notification Telegram 'Validation requise'"
        - "Retry auto après 3 min"
    - id: "US-7"
      story: |
        En tant qu'utilisateur, je veux que le scraper retry automatiquement après
        ma validation mobile afin de ne pas avoir à relancer manuellement
      acceptanceCriteria:
        - "3 retry espacés"
        - "Succès notifié après validation"

implementationPhases:
  - phase: 1
    name: "Infrastructure (MVP Foundation)"
    tasks:
      - "Configuration Docker & docker-compose"
      - "Setup Telegram Bot"
      - "Endpoint API pour trigger manuel"
      - "UI : bouton refresh + indicateur freshness"
  - phase: 2
    name: "Binance Scraper (MVP)"
    tasks:
      - "Intégration API Binance (read-only)"
      - "Récupération balances Spot + Earn"
      - "Conversion EUR + Export CSV"
      - "Cron job automatique"
  - phase: 3
    name: "Caisse d'Épargne Scraper"
    tasks:
      - "Setup Playwright dans Docker"
      - "Gestion login + auth mixte"
      - "Support 2 comptes : CE Perso + CE SCI"

setupGuides:
  telegramBot:
    steps:
      - "Chercher @BotFather sur Telegram"
      - "Envoyer /newbot et suivre les instructions"
      - "Copier le token → TELEGRAM_BOT_TOKEN"
      - "Récupérer le chat_id via https://api.telegram.org/bot<TOKEN>/getUpdates"

  environmentVariables:
    file: ".env"
    variables:
      - name: "TELEGRAM_BOT_TOKEN"
        example: "your_bot_token_here"
      - name: "TELEGRAM_CHAT_ID"
        example: "your_chat_id_here"
      - name: "BINANCE_API_KEY"
        example: "your_api_key_here"
      - name: "BINANCE_API_SECRET"
        example: "your_api_secret_here"
      - name: "SCRAPER_CRON"
        example: "0 8 5 * *"

decisionsLog:
  - decision: "Hébergement agnostique"
    rationale: "Freebox Pop ne supporte pas les VMs"
  - decision: "MVP = Binance uniquement"
    rationale: "API stable, valide l'infra d'abord"
  - decision: "2 comptes CE séparés"
    rationale: "Logins différents Perso/SCI"
  - decision: "Credentials en .env"
    rationale: "Simple, standard pour usage personnel"
