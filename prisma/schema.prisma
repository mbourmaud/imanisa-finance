generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// Member: A member of the household (may or may not have a Supabase account)
model Member {
  id                String             @id @default(uuid())
  name              String
  avatarUrl         String?
  color             String?
  createdAt         DateTime           @default(now())
  accountMembers    AccountMember[]
  investmentSources InvestmentSource[]
  loans             Loan[]
  properties        Property[]
  user              User?
}

/// User: A Supabase Auth account (may or may not be linked to a Member)
model User {
  id          String       @id @default(uuid())
  email       String       @unique
  name        String?
  avatarUrl   String?
  createdAt   DateTime     @default(now())
  memberId    String?      @unique
  dataSources DataSource[]
  rawImports  RawImport[]
  member      Member?      @relation(fields: [memberId], references: [id])
}

/// Bank: A supported bank/broker
model Bank {
  id          String    @id @default(uuid())
  name        String
  logo        String?   // Path to logo in S3/storage
  color       String    // Brand color (hex)
  description String?
  type        BankType  @default(BANK)
  parserKey   String    // Parser implementation key (credit_mutuel, boursorama, etc.)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  accounts    Account[]
}

/// Account: A bank account linked to a Bank
model Account {
  id             String          @id @default(uuid())
  name           String
  description    String?         // Optional notes or context about the account
  accountNumber  String?
  type           AccountType     @default(CHECKING)
  balance        Float           @default(0)
  currency       String          @default("EUR")
  exportUrl      String?         // URL for exporting statements
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  bankId         String
  bank           Bank            @relation(fields: [bankId], references: [id])
  accountMembers AccountMember[]
  rawImports     RawImport[]
  transactions   Transaction[]

  @@index([bankId])
}

/// AccountMember: Junction table for Account <-> Member (many-to-many with ownership share)
model AccountMember {
  id         String   @id @default(uuid())
  accountId  String
  memberId   String
  ownerShare Float    @default(100)
  createdAt  DateTime @default(now())
  account    Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  member     Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([accountId, memberId])
  @@index([accountId])
  @@index([memberId])
}

model Transaction {
  id                  String               @id @default(uuid())
  accountId           String
  type                TransactionType
  amount              Float
  currency            String               @default("EUR")
  description         String
  date                DateTime
  bankCategory        String?
  isInternal          Boolean              @default(false)
  importedAt          DateTime             @default(now())
  account             Account              @relation(fields: [accountId], references: [id], onDelete: Cascade)
  transactionCategory TransactionCategory?

  @@unique([accountId, date, amount, description])
  @@index([accountId])
  @@index([date])
  @@index([isInternal])
}

model Category {
  id                    String                @id @default(uuid())
  name                  String
  parentId              String?
  icon                  String                @default("üìÅ")
  color                 String                @default("#808080")
  parent                Category?             @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children              Category[]            @relation("CategoryHierarchy")
  rules                 CategoryRule[]
  transactionCategories TransactionCategory[]

  @@index([parentId])
}

model CategoryRule {
  id           String   @id @default(uuid())
  categoryId   String
  pattern      String
  priority     Int      @default(0)
  sourceFilter String?
  isActive     Boolean  @default(true)
  category     Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([priority])
}

model TransactionCategory {
  transactionId String         @id
  categoryId    String
  source        CategorySource @default(MANUAL)
  confidence    Float          @default(1.0)
  category      Category       @relation(fields: [categoryId], references: [id])
  transaction   Transaction    @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([categoryId])
}

model InvestmentSource {
  id           String                  @id @default(uuid())
  name         String
  type         InvestmentSourceType
  bank         String?
  notes        String?
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  memberId     String
  positions    InvestmentPosition[]
  member       Member                  @relation(fields: [memberId], references: [id])
  transactions InvestmentTransaction[]

  @@index([memberId])
}

model InvestmentPosition {
  id              String           @id @default(uuid())
  sourceId        String
  symbol          String
  isin            String?
  name            String?
  assetType       AssetType        @default(OTHER)
  quantity        Float
  avgBuyPrice     Float
  currentPrice    Float
  currentValue    Float
  gainLoss        Float
  gainLossPercent Float
  lastUpdated     DateTime         @default(now())
  createdAt       DateTime         @default(now())
  source          InvestmentSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@unique([sourceId, symbol])
  @@index([sourceId])
  @@index([assetType])
}

model InvestmentTransaction {
  id          String           @id @default(uuid())
  sourceId    String
  symbol      String
  type        String
  quantity    Float
  unitPrice   Float
  totalAmount Float
  fees        Float            @default(0)
  date        DateTime
  notes       String?
  createdAt   DateTime         @default(now())
  source      InvestmentSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([sourceId])
  @@index([date])
  @@index([symbol])
}

model Property {
  id            String           @id @default(uuid())
  name          String
  address       String?
  city          String?
  postalCode    String?
  surfaceM2     Float?
  purchasePrice Float?
  purchaseDate  DateTime?
  notaryFees    Float?
  currentValue  Float?
  notes         String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  memberId      String
  loans         Loan[]
  member        Member           @relation(fields: [memberId], references: [id])
  charges       PropertyCharge[]

  @@index([memberId])
}

model PropertyCharge {
  id         String    @id @default(uuid())
  propertyId String
  name       String
  amount     Float
  frequency  String
  startDate  DateTime
  endDate    DateTime?
  notes      String?
  property   Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
}

model Loan {
  id               String    @id @default(uuid())
  propertyId       String?
  name             String
  bank             String
  loanNumber       String?
  type             LoanType  @default(MORTGAGE)
  initialAmount    Float
  remainingAmount  Float
  rate             Float
  monthlyPayment   Float
  insuranceMonthly Float     @default(0)
  startDate        DateTime?
  endDate          DateTime?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  memberId         String
  member           Member    @relation(fields: [memberId], references: [id])
  property         Property? @relation(fields: [propertyId], references: [id])

  @@index([memberId])
  @@index([propertyId])
}

model RawImport {
  id           String          @id @default(uuid())
  userId       String
  bankKey      String
  filename     String
  storagePath  String
  fileSize     Int
  mimeType     String
  status       RawImportStatus @default(PENDING)
  errorMessage String?
  recordsCount Int?
  accountId    String?
  processedAt  DateTime?
  createdAt    DateTime        @default(now())
  skippedCount Int?
  account      Account?        @relation(fields: [accountId], references: [id])
  user         User            @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model DataSource {
  id         String         @id @default(uuid())
  userId     String
  name       String
  type       DataSourceType
  config     Json?
  lastSyncAt DateTime?
  createdAt  DateTime       @default(now())
  bankKey    String?
  user       User           @relation(fields: [userId], references: [id])
  syncStatus SyncStatus[]

  @@index([userId])
}

model SyncStatus {
  id           String     @id @default(uuid())
  dataSourceId String
  status       String
  recordsCount Int        @default(0)
  errorMessage String?
  startedAt    DateTime   @default(now())
  finishedAt   DateTime?
  dataSource   DataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)

  @@index([dataSourceId])
  @@index([startedAt])
}

model NetWorthSnapshot {
  id               String   @id @default(uuid())
  date             DateTime
  totalAssets      Float
  totalLiabilities Float
  netWorth         Float
  breakdown        Json
  memberId         String

  @@unique([memberId, date])
  @@index([memberId])
  @@index([date])
}

enum BankType {
  BANK
  INVESTMENT
}

enum AccountType {
  CHECKING
  SAVINGS
  INVESTMENT
  LOAN
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum CategorySource {
  BANK
  AUTO
  MANUAL
}

enum LoanType {
  MORTGAGE
  CONSUMER
  STUDENT
  AUTO
  OTHER
}

enum InvestmentSourceType {
  PEA
  CTO
  ASSURANCE_VIE
  PER
  CRYPTO
  CROWDFUNDING
  OTHER
}

enum AssetType {
  STOCK
  ETF
  BOND
  FUND
  CRYPTO
  CASH
  REAL_ESTATE
  OTHER
}

enum DataSourceType {
  BANK_EXPORT
  INVESTMENT_EXPORT
  MANUAL
  API
}

enum RawImportStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
}
